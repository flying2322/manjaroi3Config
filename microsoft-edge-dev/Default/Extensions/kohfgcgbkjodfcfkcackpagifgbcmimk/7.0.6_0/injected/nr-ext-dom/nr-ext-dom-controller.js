function NRDomController(){let e=this;function r(r){n(r);let i=null;i=readingBar.isImmersive?readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+(r-1))[0]:document.getElementsByClassName("nr-s"+(r-1))[0];let t=null;if(t=readingBar.isImmersive?readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+r)[0]:document.getElementsByClassName("nr-s"+r)[0],"kindle"!==doc.type){const n=l(i)||l(t);e.isAutoScroll&&n&&("undefined"!=typeof readingBar&&readingBar.hideRelocateButton(),s(r)),n||"undefined"==typeof readingBar||readingBar.showRelocateButton()}}function n(r){if("kindle"===doc.type)doc.highlightLocation(r);else{if(!e.beHighlighted.includes("sentence"))return;e.removeHighlight(),"undefined"!=typeof readingBar&&(readingBar.setImmersiveNotReadTextClass(readingBar.settings.isImmersiveBlurText),e.currHighlightedImmersiveSentence=readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+r),t(e.currHighlightedImmersiveSentence,"add","sentence")),e.currHighlightedSentence=document.getElementsByClassName("nr-s"+r),t(e.currHighlightedSentence,"add","sentence")}}function i(e=["sentence","word"]){if("undefined"!=typeof doc&&"kindle"===doc.type)1===e.length&&"word"===e[0]||doc.removeLocationHighlight();else{if(e.includes("sentence")){if(t(Array.from(document.getElementsByClassName("nr-highlighted-sentence")),"remove","sentence"),"undefined"!=typeof readingBar){t(Array.from(readingBar.immersiveReader.getElementsByClassName("nr-highlighted-sentence")),"remove","sentence")}}if(e.includes("word")){if(t(Array.from(document.getElementsByClassName("nr-highlighted-word")),"remove","word"),"undefined"!=typeof readingBar){t(Array.from(readingBar.immersiveReader.getElementsByClassName("nr-highlighted-word")),"remove","word")}}}}function t(r,n,i){if(r)for(let t=0;t<r.length;t++)r[t]&&("add"===n&&e.beHighlighted.includes(i)?(r[t].classList.add("nr-"+i+"-highlight-"+e.highlightColour),r[t].classList.add("nr-highlighted-"+i)):(r[t].classList.remove("nr-"+i+"-highlight-"+e.highlightColour),r[t].classList.remove("nr-highlighted-"+i)))}function a(r,n="pause"){e.removeHighlight(),e.highlightColour=r,"reading"===n&&(e.beHighlighted.includes("sentence")&&t(e.currHighlightedSentence,"add","sentence"),e.beHighlighted.includes("word")&&t(e.currHighlightedWord,"add","word"))}function d(r){e.beHighlighted=r,e.beHighlighted.includes("sentence")?"reading"===reader.state&&n(reader.currReadIndex):i(["sentence"]),e.beHighlighted.includes("word")||i(["word"])}function o(r){e.isAutoScroll=r,"reading"===reader.state&&e.isAutoScroll&&s(reader.currReadIndex)}function s(e){try{let r=null;r="undefined"!=typeof readingBar&&readingBar.isImmersive?readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+e)[0]:document.getElementsByClassName("nr-s"+e)[0],r&&("googleDoc"!==doc.type||"undefined"==typeof readingBar||readingBar.isImmersive?r.scrollIntoView({behavior:"smooth",block:"center"}):function(e){try{let r="scrollBehavior"in document.documentElement.style,n=doc.getViewport(),i=doc.getPageHeight()/12;i>120&&(i=120);const t=$(e).offset().top-$(n).offset().top-i;r?n.scrollBy({top:t,behavior:"smooth"}):n.scrollBy(0,t)}catch(e){}}(r),readingBar.hideRelocateButton())}catch(e){}}function l(e){if(e){const r=e.getBoundingClientRect();return"undefined"!=typeof readingBar&&readingBar.isImmersive,r.top>=0&&r.left>=0&&r.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&r.right<=(window.innerWidth||document.documentElement.clientWidth)}return!1}function g(){"undefined"!=typeof readingBar&&(a(readingBar.settings.highlightColour,reader.state),d(readingBar.settings.beHighlighted),o(readingBar.settings.isAutoScroll)),"pause"===reader.state||"init"===reader.state?i():"reading"===reader.state&&r(reader.currReadIndex)}function c(e,r){e.forEach((e=>{e.classList.add(r)}))}function m(e,r){e.forEach((e=>{e.classList.remove(r)}))}e.highlightColour="light",e.beHighlighted=[],e.isAutoScroll=!0,e.readerOnPlay=function(){r(reader.currReadIndex)},e.readerOnPause=function(){if(i(),readingBar.isImmersive&&"undefined"!=typeof nrExtImmersiveReader){const e=nrExtImmersiveReader.immersiveDocument.getElementsByTagName("nr-sentence");for(let r=0;r<e.length;r++)e[r].classList.remove("nr-not-read")}},e.readerOnStop=function(){i()},e.setCurrRead=r,e.currHighlightedSentence=null,e.currHighlightedCCSentence=null,e.currHighlightedImmersiveSentence=null,e.currHighlightedWord=null,e.currHighlightedImmersiveWord=null,e.highlightSentence=n,e.highlightWord=function(r,n){if(!e.beHighlighted.includes("word"))return;i(["word"]);let a="nr-s"+r+"w"+n;if(e.currHighlightedWord=document.getElementsByClassName(a),"undefined"!=typeof readingBar){let i=readingBar.ccText,a="nr-cc-s"+r+"w"+n;e.currHighlightedCCWord=i.getElementsByClassName(a),t(e.currHighlightedCCWord,"add","word")}t(e.currHighlightedWord,"add","word");const d="nr-immersive-s"+r+"w"+n;"undefined"!=typeof readingBar&&(e.currHighlightedImmersiveWord=readingBar.immersiveReader.getElementsByClassName(d),t(e.currHighlightedImmersiveWord,"add","word"))},e.scrollTo=s,e.highlightLocation=function(e){doc.highlightLocation&&doc.highlightLocation(e)},e.removeHighlight=i,e.setUI=g,e.scrollToAdjacentPage=function(e="next"){return new Promise((function(r){return doc.scrollToAdjacentPage?doc.alreadyParsed?r(null):doc.scrollToAdjacentPage(e).then((e=>r(e))):r("ERR")})).catch((e=>Promise.resolve("ERR")))},e.scrollToPage=function(e,r,n){return new Promise((function(r){if(doc.scrollToPage)return doc.scrollToPage(e.pageIndex).then((e=>{n(e),r(e)}));n("ERR")})).catch((e=>{n("ERR")}))},e.bindClickToReadEvents=function(r,n="default"){try{let n=parseInt(r.id.split("nr-s")[1]);r.onmouseover=()=>{if(m(Array.from(document.getElementsByClassName("nr-onhover")),"nr-onhover"),"undefined"!=typeof reader&&!reader.isFirstRead&&e.activeTabId===e.beingReadTabId&&readingBar.settings.isClickToRead){if(("pause"===reader.state||"init"===reader.state)&&doc&&"googleDoc"===doc.type)return;c(Array.from(document.getElementsByClassName("nr-s"+n)),"nr-onhover")}},r.onmouseout=()=>{m(Array.from(document.getElementsByClassName("nr-s"+n)),"nr-onhover")},r.onclick=debounce((()=>{if("undefined"!=typeof reader&&!reader.isFirstRead&&e.activeTabId===e.beingReadTabId&&readingBar.settings.isClickToRead){if(("pause"===reader.state||"init"===reader.state)&&doc&&"googleDoc"===doc.type)return;reader.readIndex(n)}}))}catch(e){}},e.bindClickToReadEventsForImmersiveReader=function(r){let n=parseInt(r.id.split("nr-immersive-s")[1]);r.onmouseover=()=>{if(m(Array.from(readingBar.immersiveReader.getElementsByClassName("nr-onhover")),"nr-onhover"),e.activeTabId===e.beingReadTabId){c(Array.from(readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+n)),"nr-onhover")}},r.onmouseout=()=>{m(Array.from(readingBar.immersiveReader.getElementsByClassName("nr-immersive-s"+n)),"nr-onhover")},r.onclick=debounce((()=>{e.activeTabId===e.beingReadTabId&&reader.readIndex(n)}))},e.isElementInViewport=l,e.asyncFunctions=["scrollToPage"],e.beingReadTabId=null,e.activeTabId=null,chrome.runtime.onMessage.addListener((function(n,t,s){if(e[n.fn]){if(e[n.fn](n,t,s),l=n.fn,e.asyncFunctions.includes(l))return!0}else"setCurrRead"===n.message?n.beingReadTabId===n.activeTabId&&r(n.index):"readerOnStop"===n.message?(reader.state="init",i()):"tabOnActivated"===n.message?(e.beingReadTabId=n.beingReadTabId,e.activeTabId=n.activeTabId,n.beingReadTabId===n.activeTabId&&n.activeTabId===n.tabId?g():i()):"highlightColourOnChange"===n.message?a(n.highlightColour,n.readerState):"beHighlightedOnChange"===n.message?d(n.beHighlighted):"isAutoScrollOnChange"===n.message?o(n.isAutoScroll):"browserActionOnClicked"===n.message&&(e.beingReadTabId=n.beingReadTabId,e.activeTabId=n.activeTabId);var l})),g()}var nrDomController=nrDomController||new NRDomController;