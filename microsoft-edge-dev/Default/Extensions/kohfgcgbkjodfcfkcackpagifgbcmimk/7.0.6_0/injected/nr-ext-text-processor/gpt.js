var doc=doc&&"gpt"===doc.type?doc:new function(){this.type="gpt";let e=this;e.docInnerText="",e.op="all",e.toRead=[];let t=[],n=!1;function r(e,t=[]){if($(e).data("read-aloud-multi-block")){let n=$(e).children(":visible").get();for(let e=0;e<n.length;e++)t.push(n[e])}else $(e).find("p, ul, ol, li").length>0?($(e).data("read-aloud-multi-block",!0),r(e,t)):t.push(e);return t}function o(t){Array.from(t.getElementsByClassName("group")).forEach((t=>{!function(t){if(t.getElementsByClassName("nr-ext-gpt-read-btn").length<=0){let n=Array.from(t.querySelectorAll("svg")).filter((e=>e.textContent&&e.textContent.includes("ChatGPT")));if(n.length>0){let t=document.getElementById("nr-ext-gpt-"+(e.iconIndex-1));if(t){let e=t.closest("div.group");e&&Array.from(e.querySelectorAll("svg")).filter((e=>e.textContent&&e.textContent.includes("ChatGPT"))).length<1&&t.remove()}let r=document.createElement("button");r.style.borderRadius="50%",r.classList.add("nr-ext-gpt-read-btn"),r.classList.add("nr-ext-play"),r.id="nr-ext-gpt-"+e.iconIndex,e.iconIndex++,r.style.marginTop="5px",n[0].parentElement.parentElement.parentElement.appendChild(r),r.onclick=function(){l(r)}}}}(t)}))}function l(e){let t=e.getAttribute("nr-ext-reader-state");t?"pause"==t?reader.play({caller:"readBtn"}):reader.pause(!0):(s(e.id),chrome.runtime.sendMessage({message:"injectReadingBarAndRead"}))}function s(t){let n=document.getElementById(e.readBtnId);n&&(reader.stop(),n.classList.contains("nr-ext-pause")&&(n.classList.remove("nr-ext-pause"),n.classList.add("nr-ext-play")),document.getElementById(e.readBtnId).removeAttribute("nr-ext-reader-state")),e.readBtnId=t}function a(){return Promise.resolve().then((()=>{t=[]})).catch((e=>{}))}function d(){try{let e=Array.from(document.querySelectorAll("div.group")).filter((e=>Array.from(e.querySelectorAll("svg")).filter((e=>e.textContent&&e.textContent.includes("ChatGPT"))).length>0));for(let t=0;t<e.length;t++){let n=e[t].getBoundingClientRect();if(n.bottom>=0&&n.right>=0&&n.top<=(window.innerHeight||document.documentElement.clientHeight)&&n.left<=(window.innerWidth||document.documentElement.clientWidth)){s(Array.from(e[t].getElementsByClassName("nr-ext-gpt-read-btn"))[0].id);break}}}catch(e){}}function i(n="all"){e.readBtnId||d();let r=document.getElementById(e.readBtnId).closest("div.group"),o=r.innerText;return e.docInnerText===o?Promise.reject("ERR_ALREADY_PARSED"):(e.docInnerText=o,new Promise((async e=>{await a(),"convert"!==n&&await removeNRTags(),e()})).then((()=>u(r))).then((e=>new Promise((async r=>{if("all"===n)for(let t=0;t<e.length;t++)await m(e[t],n);else{let n=e.map(f),r=(o=n,[].concat.apply([],o)).filter(isNotEmpty);for(let e=0;e<r.length;e++)r[e]&&t.push(r[e])}var o;r(t)})))).catch((e=>{})))}function c(n=!0,r=!0,o){let l={},s="";return e.docInnerText="",new Promise(((e,t)=>{let o=window.getSelection(),a=o.getRangeAt(0);if(l=function(){if(window.getSelection){let e=window.getSelection();if(!e.isCollapsed){let t=getRangeSelectedNodes(e.getRangeAt(0));t=t.filter((e=>{try{3==e.nodeType&&(e=e.parentElement);let t=$(e).closest(".markdown")[0],n=e.classList.contains("empty:hidden")?e:$(e).closest(".empty:hidden")[0];return!(!t&&!n)}catch(e){return!0}}));let n=[],r=[];return n=t.filter((e=>"p"===e.nodeName.toLowerCase()||"div"===e.nodeName.toLowerCase()||"ol"===e.nodeName.toLowerCase()||"ul"===e.nodeName.toLowerCase())),n=[...new Set(n)],r=t.filter((e=>3==e.nodeType&&""!==$(e).text().trim()&&"style"!==e.parentNode.nodeName.toLowerCase())),{pNodes:n,textNodes:r,allNodes:t}}}return{pNodes:[],textNodes:[],allNodes:[]}}(),l.textNodes.length>0&&l.allNodes.length>0){if(n&&(l.textNodes[0].isSameNode(l.allNodes[0])||l.allNodes[0].contains(l.textNodes[0]))){let e=l.textNodes[0].splitText(a.startOffset);l.textNodes[0]=e,l.allNodes[0]=e}r&&(l.textNodes[l.textNodes.length-1].isSameNode(l.allNodes[l.allNodes.length-1])||l.allNodes[l.allNodes.length-1].contains(l.textNodes[l.textNodes.length-1]))&&l.textNodes[l.textNodes.length-1].splitText(a.endOffset)}else s=o.toString(),l=null;o.removeAllRanges(),e()})).then((()=>new Promise((async e=>{await a(),"convert"!==o&&await removeNRTags({toNormalize:!1}),e()})))).then((()=>new Promise((e=>{if(l){let n=[],r=[],o=l.textNodes,s=l.pNodes.shift();for(let a=0;a<o.length;a++)s&&s.contains(o[a])?(r.push(o[a]),a===o.length-1&&t()):(r.length>0&&t(),s=l.pNodes.shift(),s&&s.contains(o[a])?(r.push(o[a]),a===o.length-1&&t()):n.push(o[a]));function t(){let e=[];for(let t=0;t<r.length;t++)e.push(r[t]);r=[],n.push(e)}e(n)}else e([])})).then((async e=>{if(e.length>0){for(let t=0;t<e.length;t++)Array.isArray(e[t])?await p(e[t],o):await p([e[t]],o);return Promise.resolve(t)}return s.trim()&&(t=processSentencesByLength(getNlpSentences(s))),Promise.resolve(t)})))).catch((e=>{}))}function u(t=null){return new Promise((n=>{if(t){let n=Array.from(t.getElementsByClassName("markdown"));0===n.length?e.toRead=t.getElementsByClassName("break-words")[0]:e.toRead=Array.from(Array.from(n)[0].children)}else t=null==e.readBtnId?d():document.getElementById(e.readBtnId).closest("div.group");n(e.toRead)})).catch((e=>{}))}async function m(e,t){if($(e).data("read-aloud-multi-block")){let n=$(e).children(":visible").get();for(let e=0;e<n.length;e++)$(n[e]).find("p, ul, ol, li").length>0?await m(n[e],t):await g(n[e],t)}else $(e).find("p, ul, ol, li").length>0?($(e).data("read-aloud-multi-block",!0),await m(e,t)):await g(e,t)}async function g(e,n,r=null){let o=function(e,t,n=null){let r="",o=[],l=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),s=null;for(;s=l.nextNode();)s&&((!n||("first"!==n.position||n.node.compareDocumentPosition(s)!=Node.DOCUMENT_POSITION_PRECEDING&&n.node.compareDocumentPosition(e)!=Node.DOCUMENT_POSITION_PRECEDING)&&("last"!==n.position||n.node.compareDocumentPosition(s)!=Node.DOCUMENT_POSITION_FOLLOWING&&n.node.compareDocumentPosition(e)!=Node.DOCUMENT_POSITION_FOLLOWING))&&n||$(s.parentNode).is(":visible")&&(r+=x(s),o.push(s)));return{text:r,textNodes:o}}(e,0,r),l=o.textNodes,s=processHtmlText(o.text).trim(),a=processSentencesByLength(getNlpSentences(s));if("convert"!==n)try{if(a.length>0){e.normalize();let t=createDeepCopy(a),n=0;for(;l.length>0;){let e=l.shift(),r=await h(e,t,a,n),o=r.nextIndex,s=r.remainder;s&&l.unshift(s),n!=o&&(n=o)}}}catch(e){}else t.push(...a)}async function p(e,n){let r=function(e){let t="",n=[];for(let r=0;r<e.length;r++)e[r]&&$(e[r].parentNode).is(":visible")&&(t+=x(e[r]),n.push(e[r]));return{text:t,textNodes:n}}(e);e=r.textNodes;let o=processHtmlText(r.text).trim();if("convert"===n)return void t.push(o);let l=processSentencesByLength(getNlpSentences(o)),s=createDeepCopy(l),a=0;for(;e.length>0;){let t=e.shift(),n=await h(t,s,l,a),r=n.nextIndex,o=n.remainder;o&&e.unshift(o),a!=r&&(a=r)}}async function h(e,r,o,l){try{if(!$(e).text()||""===processHtmlText($(e).text()).trim())return{nextIndex:l,remainder:null};let s=$(e).text(),a=processHtmlText(r[l]).trim(),d=l;if(processHtmlText(s).length<=a.length){a=a.substring(s.length),r[l]=a;let i=document.createElement("nr-sentence");return $(i).addClass("nr-s"+t.length),i.id="nr-s"+t.length,i.setAttribute("page",0),n&&$(i).addClass("nr-selected"),0===r[l].length&&(t.push(o[l]),d++),$(e).wrap(i),{nextIndex:d,remainder:null}}{let i=s.search(/\S|$/),c=s.length;for(;i<s.length;){for(;s[i]&&""===processHtmlText(s[i]).trim()&&(i++,s[i]););if(!s[i])break;for(;a[0]&&""===processHtmlText(a[0]).trim();)if(a=a.substring(1),0===a.length){d++;break}if(0===a.length)break;if(processHtmlText(s[i])===processHtmlText(a[0])&&(a=a.substring(1),0===a.length)){i++,d++;break}i++}c=i;let u=document.createElement("nr-sentence");$(u).addClass("nr-s"+t.length),u.id="nr-s"+t.length,u.setAttribute("page",0),n&&$(u).addClass("nr-selected"),r[l]=a,0===r[l].length&&t.push(o[l]);let m=e.splitText(c);return""===$(m).text().trim()&&(m=null),$(e).wrap(u),{nextIndex:d,remainder:m}}}catch(e){}}function f(e){return $(e).data("read-aloud-multi-block")?$(e).children(":visible").get().map(x):x(e).split(paragraphSplitter)}function x(e){return e.innerText?e.innerText:$(e).text()}e.readBtnId=null,e.isSameText=function(){if(document.getElementById(e.readBtnId)){let t=document.getElementById(e.readBtnId).closest("div.group");return e.docInnerText==t.innerText?Promise.resolve(!0):Promise.resolve(!1)}return Promise.resolve(!1)},e.iconIndex=0,this.getTexts=(r="all")=>(this.op=r,new Promise((async(o,l)=>{try{await function(t="all"){if(e.toRead=[],"all"===t)return n=!1,i(t);if("selection"===t)return n=!0,c(!0,!0,t);if("convert"===t)return n=!1,nrDomDetector.hasSelectionOnPage()?c(!0,!0,t):i(t)}(r),o(t)}catch(e){l(e)}}))),this.parseForConvertToPdf=function(){let t=document.getElementById(e.readBtnId),n=null;return t?n=t.closest("div.group"):(e.toRead=[],d(),n=document.getElementById(e.readBtnId).closest("div.group")),Promise.resolve().then((()=>e.toRead.length>0?Promise.resolve():u(n))).then((()=>{let t=[];for(let n=0;n<e.toRead.length;n++)t=t.concat(r(e.toRead[n]));return Promise.resolve(t)})).catch((e=>{}))},function(){"undefined"!=typeof gptIcons&&(gptIcons.observer.disconnect(),gptIcons.observer=null,e.readBtnId=gptIcons.readBtnId,e.iconIndex=gptIcons.iconIndex,delete gptIcons);let t=Array.from(document.getElementsByClassName("nr-ext-gpt-read-btn"));if(t.length>0)t.forEach((e=>{e.onclick=null,$(e).prop("onclick",null).off("click"),e.onclick=()=>{l(e)}}));else{let e=Array.from(document.getElementsByTagName("main"))[0];e&&o(e)}new MutationObserver((t=>{let n=Array.from(document.getElementsByTagName("main"))[0];for(const r of t){if(r.removedNodes.length>0)try{let t=document.getElementById(e.readBtnId);e.readBtnId&&!t&&("undefined"!=typeof reader&&reader.stop(),e.readBtnId=null)}catch(e){}Array.from(r.addedNodes).length>0&&n&&o(n)}})).observe(document.body,{childList:!0,subtree:!0})}()};