function WindowSpeechEngine(){let e=this;function t(t,n,a){if(t&&""!==t.trim()&&voices.freeVoices&&(!voices.freeVoices||0!==Object.keys(voices.freeVoices).length))return r().then((()=>new Promise((r=>{e.utterThis=new SpeechSynthesisUtterance,e.utterThis.text=t;let o="";reader.previewVoiceKey?(o=reader.previewVoiceKey,reader.previewVoiceKey=""):o=readingBar.settings.selectedVoice;let i=o.split(" ");i.pop(),o=i.join(" ")+" free",e.utterThis.voice=voices.freeVoices[o].voice,e.utterThis.volume=parseFloat(readingBar.settings.volume),e.utterThis.rate=utils.calculateRate(readingBar.settings.speed,voices.allVoices[o]),e.onEvent=a,function(t,r){e.utterThis.onend=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"})},e.utterThis.onerror=()=>{e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef)},e.utterThis.onstart=()=>{e.onEvent&&e.onEvent({type:"start"})};let n=0;e.utterThis.onboundary=a=>{if("word"==a.name&&(void 0!==a.charLength||void 0!==a.length)){let o=r.substr(a.charIndex,a.charLength||a.length);e.onEvent&&e.onEvent({type:"word",word:o,wordIndex:n,index:t}),n++}}}(n,t),r(voices.allVoices[o])})))).then((t=>{e.synth.speak(e.utterThis),"google"===t.source&&(e.resumeIntervalRef=setInterval((()=>{e.synth.speaking?(e.synth.pause(),e.synth.resume()):clearInterval(e.resumeIntervalRef)}),5e3))})).catch((e=>{}));a({type:"end"})}function r(){return new Promise((t=>{e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),e.utterThis&&(e.utterThis.onend=null,e.utterThis.onboundary=null,e.utterThis.onerror=null,e.utterThis=null),e.synth.cancel(),t()}))}e.type="free",e.synth=window.speechSynthesis,e.utterThis=null,e.playTimeoutRef=null,e.isStoppedWhenProcessingPlay=!1,e.isProcessingPlay=!1,e.play=t,e.pause=function(t=!0){e.stop(t)},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});return e.synth.paused?Promise.resolve().then((()=>new Promise((t=>{e.synth.resume(),t()})))).then((()=>r())).catch((function(e){})):r()},e.resume=function(e,r){t(e,r,!1)},e.onEvent=null,e.resumeIntervalRef=null}function ChromeTtsEngine(){let e=this;e.init=function(){},e.type="free",e.play=function(n,a,o){if(!n||""===n.trim()||!voices.freeVoices||voices.freeVoices&&0===Object.keys(voices.freeVoices).length)return void o({type:"end"});return r().then((function(r){e.onEvent=o,t=0;let i="";reader.previewVoiceKey?(i=reader.previewVoiceKey,reader.previewVoiceKey=""):i=readingBar.settings.selectedVoice;let s=voices.allVoices[i].voice.name||voices.allVoices[i].voice.voiceName,l=utils.calculateRate(readingBar.settings.speed,voices.allVoices[i]),u=parseFloat(readingBar.settings.volume);setTimeout((()=>{browser.tts.speak(n,{voiceName:s,rate:l,volume:u,requiredEventTypes:["start","end","word"],desiredEventTypes:["start","end","error","interrupted","word"],onEvent:r=>{!function(r,n,a){if("start"==r.type)e.onEvent&&e.onEvent({type:"start"});else if("end"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef),e.onEvent&&e.onEvent({type:"end"});else if("error"==r.type)e.resumeIntervalRef&&clearInterval(e.resumeIntervalRef);else if("word"==r.type&&(void 0!==r.charLength||void 0!==r.length)){let o=n.substr(r.charIndex,r.charLength||r.length);e.onEvent&&(e.onEvent&&e.onEvent({type:"word",word:o,wordIndex:t,index:a}),t++)}}(r,n,a)}}),"google"===voices.allVoices[i].source&&(e.resumeIntervalRef=setInterval((()=>{browser.tts.isSpeaking((function(t){t?(browser.tts.pause(),browser.tts.resume()):clearInterval(e.resumeIntervalRef)}))}),5e3))}),0)})).catch((e=>{}))},e.stop=function(t=!0){e.onEvent&&t&&e.onEvent({type:"pause"});browser.tts.stop()},e.pause=function(t=!0){e.stop(t)},e.onEvent=null,e.stopIfAlreadySpeaking=r,e.resumeIntervalRef=null;let t=0;function r(){return new Promise((function(t){e.resumeIntervalRef&&(clearInterval(e.resumeIntervalRef),e.resumeIntervalRef=null),browser.tts.isSpeaking((function(e){e&&browser.tts.stop(),t({isSpeaking:e})}))}))}}const freeTts=new WindowSpeechEngine;function OnlineTtsEngine(){class e{constructor(e,t,r,n){}}let t=this;function r(){"undefined"!=typeof readingBar&&(t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetPlaybackRate",tabId:t.playerTabId,rate:utils.calculateRate(readingBar.settings.speed)}):t.audioPlayer.playbackRate=utils.calculateRate(readingBar.settings.speed))}function n(){return new Promise((e=>{t.playTimeoutRef&&clearTimeout(t.playTimeoutRef),t.wordMarkTimer&&clearInterval(t.wordMarkTimer),t.onEvent=null,t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerClearPlay"},(()=>{e()})):(t.playPromise&&t.playPromise.then((()=>{t.audioPlayer.pause()})).catch((e=>{})),e())})).catch((e=>{}))}async function a(e,r,n){try{if(!e||!e||""===e.trim())return void(t.onEvent&&t.onEvent({type:"end"}));{let i=null!==r?r+"":readingBar.settings.selectedVoice+"_"+readingBar.settings.speed,s=null!==r?t.preloads[i]:t.previews[i];if(!s)return t.onEvent&&t.onEvent({type:"loading"}),u(e).then((a=>{t.preloads[i]={text:e,blob:a,index:r},o(t.preloads[i],n)})).catch((function(e){}));if(n!==t.playId)throw new Error("invalid playid");try{s.blob.isPending()&&t.onEvent&&t.onEvent({type:"loading"})}catch(e){}(await s.blob).text===e?o(s,n):(l(r),a(e,r,n))}}catch(e){}}async function o(e,n){try{if(n!==t.playId||!e)throw new Error("invalid playId");let o=await e.blob;o.err&&""!==o.err?(a=o.err,t.errCount++,t.errCount>=3||!d(a)?(t.hasError=!0,t.setNumPreloads(2,0),t.onEvent&&t.onEvent({type:"error",err:a,isTempError:d(a)})):(function(e){return 1002===e||1e3===e}(a)&&t.errCount>0&&t.errCount--,t.onEvent&&t.onEvent({type:"end"}))):(t.hasError&&(t.hasError=!1,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.isStoppedWhenProcessingPlay=!1,t.setNumPreloads(2,4)),async function(e,n){try{let a=null;return t.errCount=0,Promise.resolve().then((async()=>(a=await e.blob,Promise.resolve()))).then((()=>new Promise((e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetSrc",tabId:t.playerTabId,src:a.url,text:a.text},(()=>{e()})):(t.audioPlayer.src=a.url,e())})))).then((()=>new Promise((e=>{t.currentVoice&&"aca"===t.currentVoice.source?t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(.5*readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(readingBar.settings.volume),e()})))).then((()=>new Promise((e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerLoad",tabId:t.playerTabId},(()=>{e()})):(t.audioPlayer.load(),e())})))).then((()=>{if(function(){if(t.hasMediaViolation)return chrome.runtime.sendMessage({fn:"playerAddEventListenerToPlayer",tabId:t.playerTabId});t.audioPlayer.onended=()=>{t.onEvent&&t.onEvent({type:"end"})},t.audioPlayer.onplay=()=>{t.onEvent&&t.onEvent({type:"start"})},t.audioPlayer.onerror=()=>{t.onEvent&&t.onEvent({type:"error",err:t.audioPlayer.error.message})}}(),t.isStoppedWhenProcessingPlay)i();else try{if(n!==t.playId||!e)throw new Error("invalid playid");r(),t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerPlay",tabId:t.playerTabId}):t.playPromise=t.audioPlayer.play(),function(e,r,n=""){t.hasMediaViolation?(t.textForMediaViolation=e,t.marksForMediaViolation=r):t.audioPlayer.oncanplay=()=>{try{t.wordMarkTimer&&clearInterval(t.wordMarkTimer);let a=0,o=performance.now(),i=(ttsText.getTextChunks(e),0);if(r&&0===r.length){let r=e.split(" "),a=[],s=0;for(let e=0;e<r.length;e++)r[e]?(a.push(s),s=s+r[e].length+1):s++;let l=0,u=1e3*t.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),c=u/e.length*.95;t.wordMarkTimer=setInterval((()=>{let s=performance.now();if(i=s-o,i>=u||u<=0||isNaN(t.audioPlayer.duration))return void clearInterval(t.wordMarkTimer);let d=Math.floor(i/c);d>e.length?clearInterval(t.wordMarkTimer):d>=a[l]&&t.onEvent&&"openai"!==n&&t.onEvent({type:"word",word:r[l],wordIndex:l++})}),50)}else{const e=[];for(let t=0;t<r.length;t++)e.push(r[t].time/utils.calculateRate(readingBar.settings.speed));t.wordMarkTimer=setInterval((()=>{let s=performance.now();i=s-o,i>e[a]&&t.onEvent&&"openai"!==n&&(t.onEvent({type:"word",word:r[a].word,wordIndex:a++}),a>=r.length&&clearInterval(t.wordMarkTimer))}),50)}}catch(e){}}}(a.text,a.marks,t.currentVoice.source)}catch(e){}}))}catch(e){}t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1}(e,n))}catch(a){}var a}function i(e){return t.onEvent&&e&&t.onEvent({type:"pause"}),t.isProcessingPlay&&(t.isStoppedWhenProcessingPlay=!0),n()}async function s(e,r){try{if(r!==t.playId)throw new Error("inavlid playId");let n=e+"";if(t.preloads[n])return;{let r=ttsText.textsForTts[e].processed;if(!r||""===r.trim())return;t.preloads[n]={text:r,blob:p(u(r)),index:e}}}catch(e){}}function l(e){null!==e&&delete t.preloads[e+""]}function u(t){return new Promise((async(r,n)=>{let a=3,o=new e("","",[],"");for(;a>0;){const e=await c(t);e.decrementAttemptCount?(a--,a<=0&&(o=e)):(a=0,o=e)}r(o)})).catch((e=>{}))}function c(e){return new Promise((r=>{const n=function(e,r){let n="";if(reader.previewVoiceKey?(n=voices.allVoices[reader.previewVoiceKey],reader.previewVoiceKey=""):n=voices.allVoices[readingBar.settings.selectedVoice],t.ttsEndpoint=t.premTtsEndpoint,"plus"===n.type&&(t.ttsEndpoint=t.plusTtsEndpoint),t.currentVoice=n,!n.id||!n.source)throw new Error("error");let a="",o="";return o=null!==n?"&r="+n.id+"&s=0&v="+n.source:"&r=21&s=0&v=aca",r&&r.email?(a+="?e="+r.email,void 0!==r.license&&(a+="&l="+r.license),r.ownerEmail&&(a+="&o="+r.ownerEmail),a+=o):a="?l=0"+o,a+="&vn="+chrome.runtime.getManifest().version+"&sm="+t.isSpeechMark,t.ttsEndpoint+a}(t.ttsEndpoint,readingBar.settings.userInfo);chrome.runtime.sendMessage({fn:"sendTtsRequest",queryEndpoint:n,text:e},(async function(e){const n=await function(e){if(e.url){const t=atob(e.url.split(",")[1]),r=[];for(let e=0;e<t.length;e++)r.push(t.charCodeAt(e));e.url=window.URL.createObjectURL(new Blob([new Uint8Array(r)],{type:"audio/mpeg"}))}return Promise.resolve(e)}(e);return""!==n.err?(function(e){if(1002==e||1005==e||1001==e||1003==e||1004==e||1006==e||"ERR_LICENSE_INVALID"==e||"Limit Exceeded"==e||"ERR_INVALID_REQUEST"==e||"ERR_EMPTY_TEXT"==e)return!0}(n.err)||("Too Many Requests"===n.err&&(t.hasTooManyRequestsError=!0),n.decrementAttemptCount=!0),r(n)):r(n)}))})).catch((e=>{}))}function d(e){return 1001!=e&&1003!=e&&1004!=e&&1005!=e&&1006!=e&&"ERR_LICENSE_INVALID"!=e&&"Limit Exceeded"!=e&&"ERR_EMPTY_TEXT"!=e}function p(e){try{if(e.isResolved)return e;let t=!0,r=!1,n=!1,a=e.then((function(e){return n=!0,t=!1,e}),(function(e){throw r=!0,t=!1,e}));return a.isFulfilled=function(){return n},a.isPending=function(){return t},a.isRejected=function(){return r},a}catch(t){return e}}t.type="online",t.ttsEndpoint,t.premTtsEndpoint="https://avf3h4i1vc.execute-api.us-east-1.amazonaws.com/prod-cpm/tts",t.plusTtsEndpoint="https://6rbmmgxig8.execute-api.us-east-1.amazonaws.com/prod-cps/tts",t.audioPlayer=null,t.errCount=0,t.playId=void 0,t.numPreloads={prev:2,next:4},t.preloads={},t.previews={},t.hasError=!1,t.hasTooManyRequestsError=!1,t.onEvent=null,t.wordMarkTimer=null,t.play=async function(e,r,o){t.previousText=e||null;t.playId=Date.now();let i=t.playId;return t.isStoppedWhenProcessingPlay?(t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,Promise.resolve()):(await n(),Promise.resolve().then((()=>(t.onEvent=o,a(e,r,i)))).then((()=>{if(null!==r&&i===t.playId)return async function(e,r){let n={};n[e+""]=!0;for(let a=1;a<t.numPreloads.next+1&&!t.isStoppedWhenProcessingPlay;a++)try{let t=await ttsText.getIndexOfNNextSentence(a,e);if(-1===t)break;n[t+""]=!0,s(t,r)}catch(e){continue}for(let r=1;r<t.numPreloads.prev+1&&!t.isStoppedWhenProcessingPlay;r++)try{let t=await ttsText.getIndexOfNPrevSentence(r,e);if(-1===t)break;n[t+""]=!0}catch(e){continue}!function(e){for(let r in t.preloads){let n=t.preloads[r];e[r]||l(n.index)}}(n)}(r,i)})).catch((e=>{})))},t.pause=function(e=!0){t.stop(e)},t.stop=i,t.clearPreloads=function(){t.preloads={}},t.clearBlobsWithError=async function(){for(let e in t.preloads){let r=t.preloads[e],n=await r.blob;"ERR_CONVERT_LIMIT"!==n.err&&1005!=n.err&&1006!==n.err&&"ERR_LICENSE_INVALID"!==n.err||l(r.index)}},t.setNumPreloads=function(e,r){t.numPreloads={prev:e,next:r}},t.previewPlus=function e(n){reader.previewVoiceKey="";let a=voices.formPlusVoiceUrl(n);return new Promise((e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetSrc",tabId:t.playerTabId,src:a},(()=>{e()})):(t.audioPlayer.src=a,e())})).then((()=>new Promise((e=>{n&&"aca"===n.source?t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(.5*readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(.5*readingBar.settings.volume):t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerSetVolume",tabId:t.playerTabId,volume:parseFloat(readingBar.settings.volume)}):t.audioPlayer.volume=parseFloat(readingBar.settings.volume),e()})))).then((()=>new Promise((async e=>{t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerLoad",tabId:t.playerTabId},(()=>{e()})):(t.audioPlayer.load(),e())})))).then((()=>{r(),t.hasMediaViolation?chrome.runtime.sendMessage({fn:"playerPlay",tabId:t.playerTabId}):t.playPromise=t.audioPlayer.play().then((()=>{})).catch((r=>{r.message.includes("Failed to load because no supported source was found")&&chrome.runtime.sendMessage({fn:"injectPlayer",docType:doc.type},(r=>{chrome.runtime.lastError,t.hasMediaViolation=!0,t.playerTabId=r,e(n)}))}))})).catch((e=>{}))},t.isProcessingPlay=!1,t.isStoppedWhenProcessingPlay=!1,t.playPromise=null,t.hasInvalidLicenseError=!1,t.invalidLicenseErrorCount=0,t.currentVoice=null,t.isSpeechMark=!0,t.hasMediaViolation=!1,t.playerTabId=null,t.playerOnended=function(e,r,n){t.onEvent&&t.onEvent({type:"end"})},t.playerOnplay=function(e,r,n){t.onEvent&&t.onEvent({type:"start"})},t.playerOnerror=function(e,r,n){t.onEvent&&t.onEvent({type:"error",err:e.err})},t.playerOncanplay=function(){let e=t.textForMediaViolation,r=t.marksForMediaViolation;try{t.wordMarkTimer&&clearInterval(t.wordMarkTimer);let n=0,a=performance.now(),o=(ttsText.getTextChunks(e),0);if(r&&0===r.length){let r=e.split(" "),n=[],i=0;for(let e=0;e<r.length;e++)r[e]?(n.push(i),i=i+r[e].length+1):i++;let s=0,l=1e3*t.audioPlayer.duration/utils.calculateRate(readingBar.settings.speed),u=l/e.length*.95;t.wordMarkTimer=setInterval((()=>{let i=performance.now();if(o=i-a,o>=l||l<=0||isNaN(t.audioPlayer.duration))return void clearInterval(t.wordMarkTimer);let c=Math.floor(o/u);c>e.length?clearInterval(t.wordMarkTimer):c>=n[s]&&t.onEvent&&t.onEvent({type:"word",word:r[s],wordIndex:s++})}),50)}else{const e=[];for(let t=0;t<r.length;t++)e.push(r[t].time/utils.calculateRate(readingBar.settings.speed));t.wordMarkTimer=setInterval((()=>{let i=performance.now();o=i-a,o>e[n]&&t.onEvent&&(t.onEvent({type:"word",word:r[n].word,wordIndex:n++}),n>=r.length&&clearInterval(t.wordMarkTimer))}),50)}}catch(e){}},t.textForMediaViolation=null,t.marksForMediaViolation=null,t.previousText=null,t.asyncFunctions=[],t.audioPlayer=document.createElement("AUDIO"),browser.runtime.onMessage.addListener((function(e,r,n){if(t[e.fn]&&(t[e.fn](e,r,n),a=e.fn,t.asyncFunctions.includes(a)))return!0;var a}))}var onlineTts=onlineTts||new OnlineTtsEngine;