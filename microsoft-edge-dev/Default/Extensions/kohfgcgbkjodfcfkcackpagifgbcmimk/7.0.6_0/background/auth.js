(()=>{var e={ERR_SUB_NOT_FOUND:"Looks like you don't have an active Premium subscription. Please check to see if you already have Plus or an active subscription",ERR_NO_VALID_SRC:"Looks like you don't have an active payment method attached to your account. Please update your card information and try again.",ERR_PAYMENT_FAILED:"There was an issue while charging payment. If the error persists, please update your card information and try again."};chrome.auth=new function(){let n=this;function i(){return extension.activeTabId}function r(e=null){return new Promise((n=>{if(!e)return n();const i={IdToken:new chrome.CognitoIdToken({IdToken:e.idToken.jwtToken}),AccessToken:new chrome.CognitoAccessToken({AccessToken:e.accessToken.jwtToken}),RefreshToken:new chrome.CognitoRefreshToken({RefreshToken:e.refreshToken.token}),ClockDrift:e.clockDrift};let r=new chrome.CognitoUserSession(i);const t={Username:r.getIdToken().payload["cognito:username"],Pool:new chrome.CognitoUserPool({UserPoolId:"us-east-1_cIskjGoJg",ClientId:"2o2ltcq8tnme2fidk35frk2kt4"})};chrome.cognitoUser=new chrome.CognitoUser(t),chrome.cognitoUser.setSignInUserSession(r),n()})).catch((e=>{}))}function t(e=""){chrome.storage.sync.get(["userInfo"],(i=>{let t=i.userInfo&&i.userInfo.id?i.userInfo.id:null;if(t){let o={email:i.userInfo.email,id:t,username:i.userInfo.username,session:i.userInfo.session};return r(o.session).then((()=>("init"==e&&(o.licenseTimestamp=Date.now()),l(o.id,o.username)))).then((e=>{let i=e.license,r=e.pwLicNum?e.pwLicNum.toString():"0",t=e.pwLicCode?e.pwLicCode:"0",s=e.pwLicType?e.pwLicType:"pw";i?(o.licNum=i.licNum,o.license=i.licNum.toString(),o.licCode=i.licCode,o.pwLicNum=r,o.pwLicCode=t,o.pwLicType=s,i.ownerEmail&&(o.ownerEmail=i.ownerEmail)):(o.licNum=0,o.license="0",o.licCode="0",o.pwLicNum="0",o.pwLicCode="0",o.pwLicType="pw"),readingBar.setReadingBarSetting({key:"userInfo",value:o}),chrome.pe.getPeListForUser(readingBar.settings.loggedIn,o);let a=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;a>0&&chrome.tabs.sendMessage(a,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),(0!=o.licNum||reader.hasInvalidLicenseError)&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));try{reader.isWaitingForLicense&&reader.onLicenseUpdated()}catch(e){reader.stop()}}))}}))}function o(e){n.isProcessing=!0;let i="";"login"===e?i="https://www.naturalreaders.com/login-service/login?redir=ext-login&dest=ext/loading":"logout"===e?i="https://www.naturalreaders.com/login-service/extension/loggedout":"signup"===e&&(i="https://www.naturalreaders.com/login-service/signup?redir=ext-login&dest=ext/loading"),chrome.tabs.create({url:i,active:!1},(function(i){const r=i.id;let t=0,o=0;n.tabId=r,chrome.tabs.sendMessage(extension.activeTabId,{fn:"calculateScreenCenter",width:400,height:700},(i=>{i&&(i.top&&(o=i.top),i.left&&(t=i.left)),chrome.windows.create({tabId:r,type:"popup",focused:!0,width:400,height:700,left:t,top:o},(function(i){n.windowId=i.id,chrome.windows.onFocusChanged.addListener((function e(r){i.id===r||n.isProcessing||(chrome.windows.remove(i.id,(()=>{chrome.runtime.lastError})),chrome.windows.onFocusChanged.removeListener(e))})),chrome.windows.onRemoved.addListener((function e(i){n.windowId===i&&(n.isProcessing=!1,chrome.windows.onRemoved.removeListener(e))})),chrome.tabs.onUpdated.addListener((function i(r,t){if(r==n.tabId&&"complete"===t.status)return"login"===e?chrome.tabs.sendMessage(r,{fn:"login"},(()=>{chrome.runtime.lastError})):"logout"===e?chrome.tabs.sendMessage(r,{fn:"logout"},(()=>{chrome.runtime.lastError})):"signup"===e&&chrome.tabs.sendMessage(r,{fn:"signup"},(()=>{chrome.runtime.lastError})),void chrome.tabs.onUpdated.removeListener(i)}))}))}))}))}function s(e,i,t){let o,s=i.tab.id;if(e.session&&r(e.session),e&&e.user&&"string"==typeof e.user&&(o=JSON.parse(e.user)),o){let i={};i.email=o.userid,i.id=o.id,i.username=o.username,i.session=e.session,e.alreadyLoggedIn||chrome.tabs.sendMessage(s,{fn:"onAlreadyLoggedIn"},(()=>{chrome.runtime.lastError}));let r=e.license?JSON.parse(e.license):null,a=e.pwLicense?JSON.parse(e.pwLicense):r,c=a?a.num.toString():"0",d=a?a.licCode:"0",u=a?a.type:"pw";if(r&&"0"!=r.num){i.license=r.num.toString(),i.licNum=r.licNum,i.licCode=r.licCode,i.pwLicNum=c,i.pwLicCode=d,i.session=e.session,i.pwLicType=u,r.ownerEmail&&(i.ownerEmail=r.ownerEmail),readingBar.setReadingBarSetting({key:"userInfo",value:i}),readingBar.setReadingBarSetting({key:"loggedIn",value:1}),0!=i.licNum&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));let o=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(o,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),n.isProcessing=!1,t({ok:!0})}else l(o.id,o.username).then((e=>{r=e.license,c=e.pwLicNum?e.pwLicNum.toString():"0",d=e.pwLicCode?e.pwLicCode:"0",u=e.pwLicType?e.pwLicType:"pw",r?(i.licNum=r.licNum,i.license=r.licNum.toString(),i.licCode=r.licCode,i.pwLicNum=c,i.pwLicCode=d,i.pwLicType=u,r.ownerEmail&&(i.ownerEmail=r.ownerEmail)):(i.licNum=0,i.license="0",i.licCode="0",i.pwLicNum="0",i.pwLicCode="0",i.pwLicType="pw",i.session=null),readingBar.setReadingBarSetting({key:"userInfo",value:i}),readingBar.setReadingBarSetting({key:"loggedIn",value:1}),0!=i.licNum&&extension.beingReadTabId>0&&chrome.tabs.sendMessage(extension.beingReadTabId,{fn:"clearBlobsWithError"},(()=>{chrome.runtime.lastError}));let t=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(t,{fn:"setLoggedInUI"},(()=>{chrome.runtime.lastError})),chrome.pe.getPeListForUser(readingBar.settings.loggedIn,readingBar.settings.userInfo),n.isProcessing=!1}))}else chrome.tabs.onUpdated.addListener((function(e,n,i){e===s&&null!=n.url&&(n.url.includes("https://www.naturalreaders.com/login-service/auth-password?email=")&&chrome.tabs.sendMessage(s,{fn:"clearLogin"},(()=>{chrome.runtime.lastError})),n.url.includes("https://www.naturalreaders.com/login-service/extension/loggedin")&&chrome.tabs.sendMessage(s,{fn:"onLogin"},(()=>{chrome.runtime.lastError})))}))}function a(e,i,r){n.isProcessing=!1;readingBar.setReadingBarSetting({key:"userInfo",value:{licNum:0,license:"0",pwLicNum:"0",pwLicCode:"0",email:"user@naturalreaders.com",id:null,username:"",licCode:"0",session:null}}),readingBar.setReadingBarSetting({key:"loggedIn",value:0});let t=n.currentExtId&&n.currentExtId>0?n.currentExtId:extension.activeTabId;chrome.tabs.sendMessage(t,{fn:"setLoggedOutUI"},(()=>{chrome.runtime.lastError})),chrome.pe.setPeAndTts([]),r({ok:!0})}async function c(e,n,i,r){const t={id:e,username:n,provider:i,app:"ext"};let o=new URL("https://rrauikxmbg.execute-api.us-east-1.amazonaws.com/prod/"+r);return o.search=new URLSearchParams(t),fetch(o,{"Content-Type":"application/json"}).then((e=>Promise.resolve(e.json()))).catch((e=>{}))}function l(e,n){return Promise.all([c(e,n,"pw","billing"),c(e,n,"edu","license")]).then((e=>{let n=e[0],i=e[1];if(n){let e=n&&n.planDefine&&!d(n.status)?n.planDefine.licNum:0,r=n&&n.planDefine&&!d(n.status)?n.planDefine.plan:"0",t=n&&n.planDefine&&!d(n.status)?{licNum:n.planDefine.licNum,licCode:n.planDefine.plan}:null,o=n&&n.planDefine&&!d(n.status)?n.app:"pw";"stripe"===o&&(o="pw");let s=i&&i.planDefine?i.planDefine.licNum:0,a=i&&i.planDefine?{licNum:i.planDefine.licNum,licCode:i.planDefine.plan,ownerEmail:i.ownerEmail?i.ownerEmail:""}:null;return 13==e||12==e?{license:t,pwLicNum:e,pwLicCode:r,pwLicType:o}:s>=31&&s<=37||s>=40&&s<=42?{license:a,pwLicNum:e,pwLicCode:r,pwLicType:o}:{license:null,pwLicNum:e,pwLicCode:r,pwLicType:o}}return{license:null,pwLicNum:"0",pwLicCode:"0",pwLicType}})).catch((e=>{}))}function d(e){let n=!0;return n=!1,n}n.windowId=null,n.isProcessing=!1,n.tabId=null,n.currentExtId=-1,n.login=function(e,r,t){n.currentExtId=i(),o("login")},n.signup=function(e,r,t){n.currentExtId=i(),o("signup")},n.logout=function(e,r,t){n.currentExtId=i(),o("logout")},n.signupHelper=function(e,n,i){let r=n.tab.id;chrome.tabs.onUpdated.addListener((function(e,n,i){e===r&&null!=n.url&&(n.url.includes("https://naturalreaders.com/login-service/login?redir=ext-login&dest=ext/loading")&&chrome.tabs.sendMessage(r,{fn:"loginAfterSignup"},(()=>{chrome.runtime.lastError})),n.url.includes("https://www.naturalreaders.com/login-service/extension/loggedin")&&chrome.tabs.sendMessage(r,{fn:"onLogin"},(()=>{chrome.runtime.lastError})))}))},n.loginHelper=s,n.logoutHelper=a,n.updateLicense=t,n.upgrade=function(n,i,r){let t=readingBar.settings.userInfo.pwLicType;if("pw"!==t)alertHandler.displayAlertMessage("UPGRADE_UNSUPPORTED_DIALOG",{licType:t});else{let n=readingBar.settings.userInfo.email,i=readingBar.settings.userInfo.pwLicCode,r="6005";"6006"===i&&(r="6008"),data={liccodeCurr:i,liccodeNew:r,email:n,errors:e},alertHandler.displayAlertMessage("UPGRADE_DIALOG",data)}},function(){chromeRuntimeMsgExternal.setFilter("authLogin",s.bind(this)),chromeRuntimeMsgExternal.setFilter("authLogout",a.bind(this)),chrome.runtime.onMessage.addListener((function(e,n,i){e.fn in chrome.auth&&chrome.auth[e.fn](e,n,i)})),chrome.storage.sync.get(["userInfo"],(e=>{(!e||!e.userInfo||e.userInfo&&(!e.userInfo.licenseTimestamp||Date.now()-e.userInfo.licenseTimestamp>864e5))&&t("init")}))}()}})();