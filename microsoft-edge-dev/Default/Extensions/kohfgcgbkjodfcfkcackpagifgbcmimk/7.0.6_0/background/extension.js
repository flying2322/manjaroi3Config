function Extension(){let e=this;function a(){n(),utils.getActiveTab().then((async a=>{e.activeTabId||(e.activeTabId=a.id);const t=await utils.getDocType(e.activeTabId);readingBar.injectReadingBar(e.activeTabId,t,null,!0),chrome.tabs.sendMessage(e.activeTabId,{message:"browserActionOnClicked",beingReadTabId:e.beingReadTabId,activeTabId:e.activeTabId},(()=>{chrome.runtime.lastError}))}))}function t(){return new Promise((e=>{e()})).catch((e=>{}))}function n(a,t,n){let i=a?a.state:null,r=null;"loading"!==i&&clearInterval(e.loadingIconInterval),"reading"===i?r={19:"assets/img/contact.png",38:"assets/img/contact.png"}:"error"===i?r={19:"Icons/iconfavorite19x.png",38:"Icons/iconfavorite38x.png"}:"loading"===i?function(){let a=new OffscreenCanvas(40,40).getContext("2d"),t=new Date,n=16,i=40,r=40;e.loadingIconInterval=setInterval((function(){let e=parseInt((new Date-t)/1e3*n)/n;a.save(),a.clearRect(0,0,i,r),a.translate(i/2,r/2),a.rotate(2*Math.PI*e);for(let e=0;e<n;e++)a.beginPath(),a.rotate(2*Math.PI/n),a.moveTo(i/10,0),a.lineTo(i/4,0),a.lineWidth=i/30,a.strokeStyle="rgba(27, 125, 249,"+e/n+")",a.stroke();let d=a.getImageData(10,10,19,19);chrome.action.setIcon({imageData:d}),a.restore()}),1e3/30)}():chrome.action.setIcon({path:{32:"assets/img/32N.png"}})}function i(e,a,t){try{e.tabIds&&e.tabIds.length>0&&chrome.tabs.remove(e.tabIds)}catch(e){}}e.activeTabId=null,e.activeTab=null,e.activeWindowId=null,e.beingReadTabId=null,e.beingReadWindowId=null,e.beingReadTab=null,e.relocate=t,e.goToTabBeingRead=function(){e.beingReadTabId&&chrome.tabs.update(e.beingReadTabId,{active:!0})},e.setIcon=n,e.editHotkeys=function(e,a,t){chrome.tabs.create({url:"chrome://extensions/configureCommands"})},e.showUploadPage=function(e,a,t){chrome.tabs.create({url:"https://www.naturalreaders.com/online/?action=upload&source=ext-upload"})},e.showPlusVoiceDemoPage=function(e,a,t){chrome.tabs.create({url:"https://www.naturalreaders.com/plusvoicedemo.html"})},e.setShowOnboard=function(a,t,n){e.showOnboard=a.val},e.openReportIssues=function(a,t,n){chrome.tabs.create({url:"issues/issues.html",active:!1},(function(n){let i=n.id,r=null,d=null;chrome.auth.tabId=i;try{r=Math.round(screen.width/2-320),d=Math.round(screen.height/2-240)}catch(e){}chrome.windows.create({tabId:i,type:"popup",focused:!0,width:640,height:480,left:r,top:d},(function(n){e.issue=a.issue,e.issue.tab=t.tab,chrome.runtime.getPlatformInfo((function(a){e.issue.os=a.os,e.issue.platform=a}))}))}))},e.getIssue=function(a,t,n){n(e.issue)},e.removeTabs=i,e.reload=function(){chrome.storage.sync.clear((function(){chrome.runtime.lastError})),chrome.tabs.reload(extension.activeTabId),chrome.runtime.reload()},e.reloadExtAndPage=function(){chrome.tabs.reload(extension.activeTabId),chrome.runtime.reload()},e.reloadPage=function(){chrome.tabs.reload(extension.activeTabId)},e.actionOnClicked=a,e.isAsyncFunction=function(a){return e.asyncFunctions.includes(a)},e.asyncFunctions=["getIssue"],e.processingTabId={},e.loadingIconInterval=null,e.presetIndex=1,e.showOnboard=!1,e.issue=null,e.openFileInPW=function(e,a,t){const n=e.pdfUrl;chrome.tabs.create({url:"https://www.naturalreaders.com/online/?ef="+n+"&source=ext-file"})},e.oldUrl=null,chrome.runtime.onMessageExternal.addListener((function(e,a,t){if("object"==typeof e)return"isinstall"==e.action&&t({res:"yes"}),"getRemotePdf"==e.action&&pdfDoc.getRemotePdf(t),!0})),chrome.runtime.onInstalled.addListener((a=>{"install"==a.reason?chrome.storage.sync.get(["isInstalled"],(a=>{a.isInstalled?e.showOnboard=!1:(e.showOnboard=!0,storage.set({isInstalled:!0},"sync"))})):"update"==a.reason&&chrome.runtime.getManifest().version})),chrome.tabs.onRemoved.addListener((function(e,a){reader&&null===e&&reader.stop(),e===alertHandler.pwTabId&&(alertHandler.pwTabId=null),e===reader.mediaViolationTabId&&i({tabIds:[reader.audioPlayerTabId]}),e===reader.audioPlayerTabId&&(reader.audioPlayerTabId=null)})),chrome.tabs.onCreated.addListener((function(e){!reader.audioPlayerTabId&&(e.url&&e.url.includes("kohfgcgbkjodfcfkcackpagifgbcmimk/assets/player.html")||e.pendingUrl&&e.pendingUrl.includes("kohfgcgbkjodfcfkcackpagifgbcmimk/assets/player.html"))&&i({tabIds:[e.id]})})),chrome.tabs.onActivated.addListener((function(a){chrome.tabs.get(a.tabId,(async function(t){if(!(void 0!==chrome.auth&&a.tabId===chrome.auth.tabId||"undefined"!=typeof alertHandler&&a.tabId===alertHandler.tabId)){let a=e.activeTabId;e.activeTabId=t.id,e.activeWindowId=t.windowId;const n=utils.getUrlInfo(t.url),i=await utils.getDocType(e.activeTabId);e.activeTab={id:e.activeTabId,origin:n?n.origin:null,href:n?n.href:null,docType:i},null!=a&&a!==e.activeTabId&&chrome.tabs.sendMessage(a,{message:"tabOnActivated",tabId:a,beingReadTabId:e.beingReadTabId,activeTabId:e.activeTabId},(()=>{chrome.runtime.lastError})),chrome.tabs.sendMessage(e.activeTabId,{message:"tabOnActivated",tabId:e.activeTabId,beingReadTabId:e.beingReadTabId,activeTabId:e.activeTabId},(()=>{chrome.runtime.lastError})),n&&n.href&&!n.href.includes("naturalreaders.com")&&(readingBar.injectSD(e.activeTabId,i),readingBar.injectTitleBar(e.activeTabId,e.activeTab.docType),readingBar.injectEmailIcon(e.activeTabId,i),readingBar.injectGptIcon(e.activeTabId,i))}}))})),chrome.windows.onFocusChanged.addListener((function(){chrome.tabs.query({active:!0,lastFocusedWindow:!0},(async function(a){const t=a.length>0?a[0].id:e.activeTabId,n=a.length>0?a[0].windowId:e.activeWindowId;if(t!==chrome.auth.tabId&&t!==alertHandler.tabId){let i=e.activeTabId;const r=a&&a[0]?utils.getUrlInfo(a[0].url):null,d=await utils.getDocType(e.activeTabId);e.activeTab=e.activeTab||{id:e.activeTabId,origin:r?r.origin:null,href:r?r.href:null,docType:d},e.activeTabId=t,e.activeWindowId=n,null!=i&&i!==e.activeTabId&&chrome.tabs.sendMessage(i,{message:"tabOnActivated",tabId:i,beingReadTabId:e.beingReadTabId,activeTabId:e.activeTabId},(()=>{chrome.runtime.lastError})),chrome.tabs.sendMessage(e.activeTabId,{message:"tabOnActivated",tabId:e.activeTabId,beingReadTabId:e.beingReadTabId,activeTabId:e.activeTabId},(()=>{chrome.runtime.lastError}))}}))})),browser.webNavigation.onCommitted.addListener((async function(a){if("auto_subframe"!==a.transitionType&&"manual_subframe"!==a.transitionType){if(!(void 0!==chrome.auth&&a.tabId===chrome.auth.tabId||"undefined"!=typeof alertHandler&&a.tabId===alertHandler.tabId)){e.activeTabId=a.tabId;const t=utils.getUrlInfo(a.url);a.url;const n=await utils.getDocType(e.activeTabId);e.activeTab={id:e.activeTabId,origin:t?t.origin:null,href:t?t.href:null,docType:n},t&&t.href&&!t.href.includes("naturalreaders.com")&&(readingBar.injectSD(e.activeTabId,n),readingBar.injectQuickStart(e.activeTabId,e.activeTab.docType),readingBar.injectTitleBar(e.activeTabId,e.activeTab.docType),readingBar.injectEmailIcon(e.activeTabId,n),readingBar.injectGptIcon(e.activeTabId,n))}a.tabId===reader.mediaViolationTabId&&i({tabIds:[reader.audioPlayerTabId]})}})),chrome.action.onClicked.addListener((async function(){a()})),chrome.runtime.onMessage.addListener((function(a,t,n){if(a.fn in e&&(e[a.fn](a,t,n),e.isAsyncFunction(a.fn)))return!0})),chrome.commands.onCommand.addListener((function(n){const i=e.beingReadTabId>0?e.beingReadTabId:e.activeTabId;if("activate"===n)a();else if("play"==n)"reading"===readingBar.settings.readerState?reader.pause(i):chrome.tabs.sendMessage(e.activeTabId,{message:"hasSelectionOnPage"},(a=>{chrome.runtime.lastError,a?reader.readSelection(null,{tab:{id:e.activeTabId}}):reader.isFirstRead?reader.injectReadingBarAndRead():reader.play(e.activeTabId)}));else if("stop"==n)reader.stop(!1);else if("forward"==n)chrome.tabs.sendMessage(e.activeTabId,{fn:"forward"},(()=>{chrome.runtime.lastError}));else if("rewind"==n)chrome.tabs.sendMessage(e.activeTabId,{fn:"backward"},(()=>{chrome.runtime.lastError}));else if("toggleShowReadIcon"==n){let a=!readingBar.settings.readIcon;readingBar.setReadingBarSetting({key:"readIcon",value:a}),chrome.tabs.sendMessage(e.activeTabId,{message:"toggleShowReadIcon",value:a})}else"speaker"==n?(chrome.tabs.sendMessage(e.activeTabId,{fn:"setPresetAsSelectedVoice",index:e.presetIndex},(()=>{chrome.runtime.lastError})),1==e.presetIndex?e.presetIndex=2:e.presetIndex=1):"goToTabBeingRead"===n?t():"readSelection"===n&&reader.readSelection()})),chrome.storage.sync.get(["isInstalled"],(a=>{a.isInstalled?e.showOnboard=!1:e.showOnboard=!0}))}const extension=new Extension;