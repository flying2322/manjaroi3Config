(function(){var e;e=function(e,t,r,i,n,a,s,o,d,u,c,l,m,p,f,y,g,h){var v,T,S,b,L,R,x,E,I,M,q,P,O,H;return"[performanceTracker]",T=[],I={},S={id:"",url:"",proxy:"",timeSendHeaders:-1,timeHeadersReceived:-1,timeEnded:-1,contentLength:0,error:"",type:"latency"},getYoutubeId=function(e){var t=e.match(/^https:\/\/([.a-z0-9-]+)\.googlevideo\.com[.a-z0-9-%/?&=_,]+/i);return!!(t&&t[1].indexOf("-")>0)&&t[1]},function(e){var t=e.match(/https:\/\/www\.youtube\.com\/yts\/img\/favicon_[a-zA-Z0-9=\-]+\.png\?([a-f0-9=]+)$/i);return!!t&&(!(t[1].indexOf("=")>0)||t[1].split("=")[0])},M=function(e,t){var r={server_id:e,latency:t.latency,time:t.time};o.emit("latency-report",r,function(e){})},q=function(e,t){var r={server_id:e,speed:t.speed,time:t.time,size:t.size};o.emit("speed-report",r,function(e){})},v=function(e){var t,r,i;if("speed"===e.type){if(i=e.timeEnded-e.timeHeadersReceived>10?e.contentLength/(e.timeEnded-e.timeHeadersReceived):e.contentLength/20,r=a.getProxyById(e.proxy)){e.error?(a.setSpeed(r,0),r.stability=a.setStability(r,0)):(a.setSpeed(r,i),r.stability=a.setStability(r,1)),q(e.proxy,{speed:parseInt(i),time:c.milliTime(),size:e.size});var n=r.score,s=a.calcEvaluation(r);!n||s>=r.score?r.acc=!0:r.acc=!1,a.setScore(r,s)}}else if("latency"===e.type){if((t=e.timeHeadersReceived-e.timeSendHeaders)<=0&&(t=3e3),r=a.getProxyById(e.proxy)){e.error?(r.fail=Math.max(1,r.fail+1),r.stability=a.setStability(r,0)):(r.fail=Math.min(-1,r.fail-1),r.latency=a.setLatency(r,t),r.stability=a.setStability(r,1),M(e.proxy,{latency:parseInt(t),time:c.milliTime()})),t<3e3&&(u.enqueue(r.server_id,t),r.averageLatency=u.average(r.server_id),r.jitter=u.standardDeviation(r.server_id),u.getLength(r.server_id)>20&&u.dequeue(r.server_id));n=r.score,s=a.calcEvaluation(r);!n||s>=r.score?r.acc=!0:r.acc=!1,a.setScore(r,s)}}else"googleVideoTest"===e.type?(i=e.contentLength/(e.timeEnded-e.timeSendHeaders),t=e.timeHeadersReceived-e.timeSendHeaders,(r=a.getProxyById(e.proxy))&&(e.error?(r.fail=Math.max(1,r.fail+1),a.setGoogleVideoSpeed(r,0),a.setGoogleVideoStability(r,0)):(t>0&&isFinite(i)?(r.fail=Math.min(-1,r.fail-1),a.setGoogleVideoLatency(r,t),a.setGoogleVideoSpeed(r,i),a.setGoogleVideoStability(r,1)):(r.fail=Math.max(1,r.fail+1),a.setGoogleVideoSpeed(r,0),a.setGoogleVideoStability(r,0)),isFinite(e.contentLength)&&a.addGoogleVideoData(e.contentLength)),r.googleVideoTestTime=c.time())):"youtubeLatency"===e.type&&(i=e.contentLength/(e.timeEnded-e.timeHeadersReceived),t=e.timeHeadersReceived-e.timeSendHeaders,(r=a.getProxyById(e.proxy))&&(e.error?(r.fail=Math.max(1,r.fail+1),a.setStability(r,0)):(r.fail=Math.min(-1,r.fail-1),a.setYoutubeLatency(r,t),a.setStability(r,1))));return delete I[e.id]},E=function(e){var t,r,i,n;if(null,!1,r=e.url.indexOf("_MSPROXY_NAME=")>0)return r?(t=r&&-1===e.url.indexOf("_MSPROXY="),n=m.parseUri(e.url),(i=angular.copy(S)).id=e.requestId,i.url=e.url,i.proxy=n.query._MSPROXY_NAME,i.timeSendHeaders=parseInt(e.timeStamp),i.type=t?"speed":"latency","speed"===i.type&&(i.size=n.query.s),I[e.requestId]=i):void 0},R=function(e){var t,r,i,n,a,s;if(i=I[e.requestId]){for(t=0,n=0,a=(s=e.responseHeaders).length;n<a;n++)if("content-length"===(r=s[n]).name.toLowerCase()){t=parseInt(r.value);break}return i.timeHeadersReceived=parseInt(e.timeStamp),i.contentLength=t}},L=function(e){var t,r=T.indexOf(e.requestId);if(r>-1&&T.splice(r,1),t=I[e.requestId])return t.timeEnded=parseInt(e.timeStamp),t.error=e.error,v(t)},provideCredentialsAsync=function(e,r){if(!0===e.isProxy){var i=a.getTopProxy();if(!i)return T.push(e.requestId),void r({authCredentials:{username:"",password:h}});var n=s.getChicagoUsername(),o=s.getChicagoPassword();-1!=T.indexOf(e.requestId)?(a.providedInvalidCredentials(i),t.log("bad credentials for: "+e.requestId),r({cancel:!0})):(T.push(e.requestId),t.log("providing credentials for: "+e.requestId),r({authCredentials:{username:n,password:o}}))}else r()},b=function(e){var t,r=T.indexOf(e.requestId);if(r>-1&&T.splice(r,1),t=I[e.requestId])return t.timeEnded=parseInt(e.timeStamp),v(t)},x=function(t){var r;if("net::ERR_PROXY_CONNECTION_FAILED"!==(r=t.error)&&"net::ERR_TUNNEL_CONNECTION_FAILED"!==r){if("net::ERR_NETWORK_CHANGED"!==(r=t.error))return e.proxies[0],chrome.proxy.settings.get({},function(e){return chrome.management.getAll(function(t){var r,i,n,a,s,o;for(i=[],n=0,a=t.length;n<a;n++)(r=t[n]).enabled&&r.id!==chrome.runtime.id&&"extension"===r.type&&i.push(r.name);null!=(s=e.value)&&null!=(o=s.pacScript)&&o.data.slice(-1e3)})});o.resetRetrial()}},H={speed:{queue:[],doing:!1},latency:{queue:[],doing:!1},youtubeLatency:{queue:[],doing:!1}},O=function(e,r){var i,o;if(!(o=H[r]).doing){if(o.doing=!0,afterSpeedTest=function(){return o.doing=!1,e[r+"TestTime"]=c.time()},errorSpeedTest=function(){return o.doing=!1,e[r+"TestTime"]=c.time()},afterLatencyTest=function(i){return i&&i.ip&&(t.log("resp.ip:"+i.ip),s.setCurrentIP(i.ip)),o.doing=!1,e[r+"TestTime"]=c.time()},afterYoutubeLatencyTest=function(t){return o.doing=!1,e[r+"TestTime"]=c.time()},errorLatencyTest=function(){return o.doing=!1,e.fail=Math.max(1,e.fail+1),e.stability=a.setStability(e,0),e[r+"TestTime"]=c.time()},i={method:"GET"},"latency"===r){var d=e.latency_host?e.latency_host:e.host;return i.url=e.latency_scheme+"://"+d+":"+e.latency_port+e.latency_path+"?_MSPROXY_NAME="+e.server_id+"&_MSPROXY=DIRECT&v="+l.md5(f)+"&t="+c.time(),i.timeout=1e4,n(i).success(afterLatencyTest).error(errorLatencyTest)}if("speed"===r){var u=5e5;e.speed_size&&(u=e.speed_size),u=parseInt(u*a.getSpeedTestDataRatio(),10);d=e.speed_host?e.speed_host:e.host;return i.url=e.speed_scheme+"://"+d+":"+e.speed_port+e.speed_path+"?_MSPROXY_NAME="+e.server_id+"&s="+u+"&v="+l.md5(f)+"&t="+c.time(),i.timeout=12e4,n(i).success(afterSpeedTest).error(errorSpeedTest)}return"youtubeLatency"===r?(i.url="https://www.youtube.com/yts/img/favicon_96-vfldSA3ca.png?"+e.server_id+"="+c.time(),i.timeout=6e4,n(i).success(afterYoutubeLatencyTest).error(errorLatencyTest)):void 0}},P=_.once(function(){var t;return t=function(){var t,r,i,n,s,o,d,u,l,m;if(u=(l=a.speedTestProxies()).length,m=[],a.isDataSavingModeStop())return m;for(d=0;d<u;d++){if(t=(r=l[d]).fail,i=Math.abs(t),n=e.user.role===p.VIP?Math.min(4800,600+3600*Math.pow(i/50,2)):Math.min(7200,1200+7200*Math.pow(i/50,2)),r.speedTestTime+n<c.time()){O(r,"speed");break}m.push(void 0)}for(u=(l=a.speedTestProxies()).length,o=0;o<u;o++)if(t=(r=l[o]).fail,i=Math.abs(t),s=Math.min(800,10+800*Math.pow(i/5,2)),r.latencyTestTime+s<c.time()){e.latency_times+=1,O(r,"latency");break}return m},setTimeout(function(){return setInterval(t,2e4)},1e4)}),this.getFingerPrint=function(){return"performanceTracker-"+(this.init.toString().length+v.toString().length+P.toString().length)},this.clearJitters=function(){u.clearAll()},this.init=function(){return chrome.webRequest.onSendHeaders.addListener(E,{urls:["<all_urls>"]}),chrome.webRequest.onHeadersReceived.addListener(R,{urls:["<all_urls>"]},["responseHeaders"]),chrome.webRequest.onCompleted.addListener(b,{urls:["<all_urls>"]}),chrome.webRequest.onAuthRequired.addListener(provideCredentialsAsync,{urls:["<all_urls>"]},["asyncBlocking"]),chrome.webRequest.onErrorOccurred.addListener(L,{urls:["<all_urls>"]}),chrome.proxy.onProxyError.addListener(x),P(),t.log("[performanceTracker]","performanceTracker Ready!")},this},define(["../app","underscore","./storage","./generate","./proxyManager","./userManager","./timeUtils","./jitterQueues","./server"],function(t){return t.service("performanceTracker",["$rootScope","$log","$timeout","$interval","$http","proxyManager","userManager","server","storage","jitterQueues","timeUtils","generate","domainUtils","ROLES","VER","LATENCY_CONTEXT_PATH","SPEED_CONTEXT_PATH","DEFAULT_PROXY_PASS",e])})}).call(this);