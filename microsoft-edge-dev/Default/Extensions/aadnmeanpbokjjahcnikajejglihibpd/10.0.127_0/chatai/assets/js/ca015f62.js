"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[670],{6356:(t,e,s)=>{s.d(e,{X:()=>d});var i=s(3234),n=s(6918),a=s(7107),o=s(8699),r=s(6626);function d(t){var e;void 0===t&&(t=1/0);var s=(e=t&&"object"==typeof t?t:{count:t}).count,d=void 0===s?1/0:s,c=e.delay,h=e.resetOnSuccess,l=void 0!==h&&h;return d<=0?a.y:(0,i.e)((function(t,e){var s,i=0,a=function(){var h=!1;s=t.subscribe((0,n.x)(e,(function(t){l&&(i=0),e.next(t)}),void 0,(function(t){if(i++<d){var l=function(){s?(s.unsubscribe(),s=null,a()):h=!0};if(null!=c){var u="number"==typeof c?(0,o.H)(c):(0,r.Xf)(c(t,i)),g=(0,n.x)(e,(function(){g.unsubscribe(),l()}),(function(){e.complete()}));u.subscribe(g)}else l()}else e.error(t)}))),h&&(s.unsubscribe(),s=null,a())};a()}))}},5670:(t,e,s)=>{s.r(e),s.d(e,{NEWCHAT_ID:()=>K,PlanProduct:()=>Q,useChatGptStore:()=>et});var i=s(3131),n=s(5676),a=s(4891),o=s(8793),r=s(393),d=s(661),c=s(6146),h=s(4275),l=s(9857),u=Math.max,g=Math.min;const p=function(t,e,s){var i=null==t?0:t.length;if(!i)return-1;var n=i-1;return void 0!==s&&(n=(0,l.Z)(s),n=s<0?u(i+n,0):g(n,i-1)),(0,c.Z)(t,(0,h.Z)(e,3),n,!0)};var v=s(385),m=s(4348);const I=function(t){return function(e,s,i){var n=Object(e);if(!(0,v.Z)(e)){var a=(0,h.Z)(s,3);e=(0,m.Z)(e),s=function(t){return a(n[t],t,n)}}var o=t(e,s,i);return o>-1?n[a?e[o]:o]:void 0}}(p);var f=Math.max;const L=function(t,e,s){var i=null==t?0:t.length;if(!i)return-1;var n=null==s?0:(0,l.Z)(s);return n<0&&(n=f(i+n,0)),(0,c.Z)(t,(0,h.Z)(e,3),n)};var w=s(7990),T=s(8424);const y=function(t,e){return!!(null==t?0:t.length)&&(0,T.Z)(t,e,0)>-1};const k=function(t,e,s){for(var i=-1,n=null==t?0:t.length;++i<n;)if(s(e,t[i]))return!0;return!1};var M=s(8658),S=s(7408);const C=function(){};var b=s(1291);const P=S.Z&&1/(0,b.Z)(new S.Z([,-0]))[1]==1/0?function(t){return new S.Z(t)}:C;const D=function(t,e,s){var i=-1,n=y,a=t.length,o=!0,r=[],d=r;if(s)o=!1,n=k;else if(a>=200){var c=e?null:P(t);if(c)return(0,b.Z)(c);o=!1,n=M.Z,d=new w.Z}else d=e?[]:r;t:for(;++i<a;){var h=t[i],l=e?e(h):h;if(h=s||0!==h?h:0,o&&l==l){for(var u=d.length;u--;)if(d[u]===l)continue t;e&&d.push(l),r.push(h)}else n(d,l,s)||(d!==r&&d.push(l),r.push(h))}return r};const x=function(t){return t&&t.length?D(t):[]};var A=s(7712),R=s(8885),O=s(8514),U=s(2288),E=s(3889);var q,N=s(5981),j=s(2098),_=s(8699),F=s(1507),Z=s(6356),H=s(7268),B=s(8476);s(435);function V(t){let e,s,i,n=!1;return function(a){void 0===e?(e=a,s=0,i=-1):e=function(t,e){const s=new Uint8Array(t.length+e.length);return s.set(t),s.set(e,t.length),s}(e,a);const o=e.length;let r=0;for(;s<o;){n&&(e[s]===q.NewLine&&(r=++s),n=!1);let a=-1;for(;s<o&&-1===a;++s)switch(e[s]){case q.Colon:-1===i&&(i=s-r);break;case q.CarriageReturn:n=!0;case q.NewLine:a=s}if(-1===a)break;t(e.subarray(r,a),i),r=s,i=-1}r===o?e=void 0:0!==r&&(e=e.subarray(r),s-=r)}}!function(t){t[t.NewLine=10]="NewLine",t[t.CarriageReturn=13]="CarriageReturn",t[t.Space=32]="Space",t[t.Colon=58]="Colon"}(q||(q={}));var Y=s(4003),G=s(1785),$=s(2731);const W=(0,n.useUserStore)(),K="newChat",z=()=>({name:i18n("xin166a49"),id:K,messages:[],updateTime:d().format("YYYY-MM-DD HH:mm")});let Q;!function(t){t.STANDARD="standard",t.PROFESSIONAL="professional",t.PREMIUM="premium"}(Q||(Q={}));const X=new class{constructor(t,e,s){this.state=e,this.type=t;const i=`${t}-retrieve`;E.y.listen(t,(t=>{this.state=t,null==s||s(t)})),E.y.listen(i,(()=>{E.y.post(t,this.state)})),setTimeout((()=>{E.y.post(i,null)}),50)}getState(){return this.state}setState(t){this.state=t,E.y.post(this.type,t)}}("client:chatai-pending",{pending:!1},(async function(t){t.pending||st();t.closeRequestPage&&await(0,j.n)()&&(et().releasePending(),X.setState({closeRequestPage:!1}))}));let J;const tt={supportSuffixText:[],supportSuffix:"",loadingText:"",limitSize:10485760},et=(0,i.Q_)(r.BU.chatgpt,{syncStorage:{watch:["customLinks","panelType","linksList","chatTips","conversionList","planList","overLimit","historyTipsReaded","chatAssistantList","removedList","theme","vipGroup","closedExpiredTime","chatModelList","double11PlanList","extraPackList","extraTips","containerRect","coUserTypeData","subPlanList"]},syncCloud:{watch:["customLinks","panelType","historyTipsReaded","theme","closedExpiredTime"]},state:()=>({modalShow:!1,linksList:[],selectedLink:null,panelType:"chatai",customLinks:[],conversionList:[z()],activeConversionId:K,chatTips:i18n("shi4ceb74"),pending:!1,chatLoading:!1,modelLoading:!0,pagination:{pageNo:0,loading:!1,finished:!1},sponsorShow:!1,controller:null,tempId:void 0,planList:[],planSelectedIndex:1,highlihgtPlanProduct:"",vipTipsShow:!1,vipTipsContent:"",overLimit:0,vipGroup:void 0,historyTipsReaded:!1,chatAssistantList:[],activeAssistantId:"",assistantListShow:!1,removedList:[],theme:"",panelShowType:"",orderList:[],closedExpiredTime:0,isRequestPage:!1,paymentOrderData:null,localCurrentTime:0,createOrderParams:{planId:"",payPlatform:""},payOrderIds:new Set,chatModelList:[],selectedModel:null,chatVipDetail:{name:"",banner:"",showBuyCount:!1,warnToBuyCount:!1,renewalConfirm:!1,show3d5Count:!1,renewalConfirmDesc:"",rest:{"3d5":-1,4:-1,image:-1,basicImage:-1}},vipDetailLoading:!1,isFreeOrder:!1,containerRect:{w:$.Pe.w,h:$.Pe.h},double11PlanList:[],double11PlanSelect:0,fromTag:"",firstReq:!0,extraPackList:[],extraTips:[],extPlans:[],extpackRest:{rest:{"3d5":0,4:0,image:0,basicImage:0}},extraPackOrders:[],showRenewalConfirm:!1,mjTasks:new Set,pendingMainTaskIds:new Set,mjTaskReqCount:0,scrollChatRef:null,preUploadLoading:!1,uploadDocModalShow:!1,uploadMetaData:tt,uploadDocConversationId:"",uploadDocLoading:!1,selectDocFile:null,coUserTypeData:{typename:"",chatDefaultLogo:"",chatPLogo:"",chatWLogo:"",label:"",id:"",updateTime:0},historyFirstReq:!0,networkOption:"chat",networkSwitch:!1,netSearchArguments:null,toolCallId:"",toolName:"",netSearchLoading:!1,subPlanList:[],subPlanPeriodIndex:0,subSelectedProduct:"",subConfirmModalShow:!1}),getters:{conversionDataList(){return this.conversionList.map((t=>{var e,s;return{...t,name:(null===(e=t.messages[0])||void 0===e?void 0:e.content)||i18n("xin166a49"),updateTime:d(null===(s=t.messages[0])||void 0===s?void 0:s.updateTime).format("YYYY-MM-DD HH:mm")}}))},activeConversionItemOrigin(){const t=this.conversionList.find((t=>t.id===this.activeConversionId));return t||z()},assistantListMapper(){const t={};return this.chatAssistantList&&this.chatAssistantList.forEach((e=>{t[e.id]=e})),t},activeConversionItem(){const t=this.activeConversionItemOrigin;let e=null;return t.messages=t.messages.map((t=>{if("user"===t.role){e!==t.assistantId&&(t.newAssistant=!0),e=t.assistantId;const s=this.assistantListMapper[e];e&&t.newAssistant&&s?(t.assistantLogo=s.logo,t.assistantTitle=s.title):!t.newAssistant||e&&s||(t.assistantLogo=void 0,t.assistantTitle=void 0)}else if("assistant"===t.role){t.assistantId=e;const s=this.assistantListMapper[e];e&&s&&(t.assistantLogo=s.logo)}return t})),t},userOperationDisabled(){return!W.isLogin||this.pending||this.chatLoading},activeAssistant(){var t;return null===(t=this.chatAssistantList)||void 0===t?void 0:t.find((t=>t.id===this.activeAssistantId))},activeTheme(){return(0,n.useUserStore)().chatStatus.vip?this.theme?this.theme:"chat-purple":"chat-default"},activeSelectModel(){if(this.selectedModel)return this.selectedModel;const t=this.chatModelList.find((t=>t.default));return t||(this.chatModelList.length>0?this.chatModelList[0]:{abbName:"",id:"",name:"",limitKey:"",planKey:""})},operationDisabled(){let t=!1;return this.conversionDataList.forEach((e=>{e.messages.find((t=>t.loading||t.pending))&&(t=!0)})),t},currentPlanList(){var t;return(null===(t=this.planList[this.planSelectedIndex])||void 0===t?void 0:t.children)||[]},currentSubPlanList(){var t;return(null===(t=this.subPlanList[this.subPlanPeriodIndex])||void 0===t?void 0:t.children)||[]},double11CurrentPlan(){var t;return null===(t=this.double11PlanList[this.double11PlanSelect])||void 0===t?void 0:t.children},double11PricePanel(){return this.double11PlanList.map((t=>`${t.title} ${t.discountStr}`))},canSelectDocument(){return this.chatVipDetail.rest[4]>0}},actions:{setModal(t){this.modalShow=t},setPanelType(t){this.panelType=t},setPanelShowType(t){"chatai-subscribe"===t&&(this.subConfirmModalShow=!1),this.panelShowType=t,"chat-expense"===this.panelType&&this.setPanelType("chatai")},setSubConfirmModalShow(t){this.subConfirmModalShow=t},setContainerRect(t){this.containerRect=t},setSelectLink(t){this.selectedLink=t},setVipGroup(t){this.vipGroup=t},addCustomLink(t){const e=[...this.customLinks];e.push(t),this.customLinks=e},removeCustomLink(t){const e=[...this.customLinks];e.splice(t,1),this.customLinks=e},setNetworkOption(t){this.networkOption=t},setNetworkSwitch(t){this.networkSwitch=t},resetNetoption(){this.networkOption="once",this.networkSwitch=!1},resetNetOnce(){this.networkSwitch&&"once"===this.networkOption&&(this.networkOption="once",this.networkSwitch=!1)},getNetworkMode(){return this.networkSwitch?"chat"===this.networkOption?"auto":"once"===this.networkOption?"network":"close":"close"},removeOriginLink(t){t&&(this.removedList.unshift(t),this.removedList.length>10&&(this.removedList.length=10),this.removedList=[...this.removedList])},setActiveConversionId(t){this.activeConversionId=t,this.resetNetoption(),(0,H.Y3)((()=>{this.scrollChatContentToBottom()}))},setHighlihgtPlanProduct(t){t&&(this.highlihgtPlanProduct=t)},async deleteConversionItem(t){const e=this.conversionList.find((e=>e.id===t));if(!e)return;if(e.messages.forEach((e=>{"image"===e.chatType&&e.imageTaskId&&e.imageId&&this.removeMjTask(t,e.imageTaskId,e.imageId)})),this.conversionList=this.conversionList.filter((e=>e.id!==t)),t===this.activeConversionId&&(this.conversionDataList.length>0?this.activeConversionId=this.conversionDataList[0].id:this.newChatHandler()),!this.isServerId(t))return;const[s,i]=await(0,a.x)(t)},newChatHandler(){const t={name:i18n("xin166a49"),id:K,messages:[],updateTime:d().format("YYYY-MM-DD HH:mm")};this.conversionList=[t,...this.conversionList],this.activeConversionId=K,this.activeAssistantId="",this.setSelectModel()},async reqGptLinks(){const[t,e]=await(0,a.lk)();!t&&e&&(this.linksList=e,this.selectedLink=e[0])},resetPage(){this.conversionList=[z()],this.activeConversionId=K,this.planList=[],this.planSelectedIndex=1,this.overLimit=0,this.vipGroup=void 0,this.pagination={pageNo:0,loading:!1,finished:!1},this.historyFirstReq=!0},async reqConversionList(){const t=this.historyFirstReq;var e;if(X.getState().pending)return void(this.activeConversionId=(null===(e=this.conversionList[0])||void 0===e?void 0:e.id)||K);if(this.pagination.loading||this.pagination.finished)return;this.pagination={...this.pagination,loading:!0};const[s,i]=await(0,a.pp)(this.pagination.pageNo);if(!s&&i){var n;if(this.historyFirstReq=!1,t)this.conversionList=[z(),...i.list];else if(this.conversionList=[...this.conversionList,...i.list],this.activeConversionId===K)this.activeConversionId=(null===(n=this.conversionList[0])||void 0===n?void 0:n.id)||K;i.totalPages-i.pageNo<=1?this.pagination={...this.pagination,finished:!0,loading:!1}:this.pagination={pageNo:i.pageNo+1,loading:!1,finished:!1},i.list.forEach((t=>{t.messages.forEach((e=>{"image"===e.chatType&&e.imageTaskId&&e.imageId&&[0,1].includes(e.imageStatucCode)&&this.appendMjTask(t.id,e.imageTaskId,e.imageId)}))}))}},addUserMessage(t,e){const s=[...this.conversionList],i=s.find((t=>t.id===e));null==i||i.messages.push({role:"user",content:t,updateTime:d().valueOf(),assistantId:this.activeAssistantId||void 0}),this.conversionList=s},onClickTryIt(){this.sendChatMessage(this.chatTips,K)},onClickTest(){},async reqChatTips(){const[t,e]=await(0,a.Fh)();!t&&e&&(this.chatTips=e)},async reqAssistantList(){const[t,e]=await(0,a.Vq)();!t&&e&&(this.chatAssistantList=e)},updatePendingMessage(t){const e=[...this.conversionList],s=e.find((e=>e.id===t.conversionId)),i=s.messages.find((t=>t.loading));i&&(i.loading=!1,i.pending=!0),this.pending=!0,X.setState({pending:!0});const n=s.messages.find((t=>t.pending));return t.modelId&&(n.modelId=t.modelId),t.id&&(this.tempId=t.id),t.error?(n.error=!0,n.content=t.content,n.pending=!1,n.extra=t.showNewBtn,this.pending=!1,this.conversionList=e,this.isRequestPage=!1,X.setState({pending:!1}),void this.resetNetOnce()):t.done?(n.pending=!1,this.isServerId(t.conversionId)||this.tempId&&(s.id=this.tempId,this.activeConversionId=this.tempId),this.resetNetOnce(),n.content+=t.content,n.searchLoading=!1,this.conversionList=e,this.pending=!1,this.isRequestPage=!1,void X.setState({pending:!1})):(t.id&&(this.tempId=t.id),t.searchText&&(n.searchLoading=t.searchLoading,n.searchText=t.searchText,n.searchUrl=t.searchUrl),n.content+=t.content,n.searchLoading=t.searchLoading,void(this.conversionList=e))},createLoadingMsg(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"chat",s=arguments.length>2?arguments[2]:void 0;const i=[...this.conversionList],n=i.find((e=>e.id===t));"chat"===e?n.messages.push({role:"assistant",content:"",loading:!0}):"image"===e?n.messages.push({role:"assistant",content:"",chatType:"image",processing:!0,processingPercent:0,imageTaskId:s||"",imageStatucCode:0}):"basicImage"===e&&n.messages.push({role:"assistant",content:"",chatType:"basicImage",processing:!0,imageId:s||""}),this.conversionList=i,(0,H.Y3)((()=>{this.scrollChatContentToBottom()}))},scrollChatContentToBottom(){if(!this.scrollChatRef)return;const t=(this.scrollChatRef.scrollHeight||0)-(this.scrollChatRef.clientHeight||0);this.scrollChatRef.scrollTo({top:t,behavior:"auto"})},setNewLocalId(){const t=this.conversionList.find((t=>t.id===K&&t.messages.length>0));t&&(t.id=this.createLocalId(),this.conversionList=[...this.conversionList])},createLocalId:()=>(0,U.kb)(K),isServerId:t=>!!t&&!t.startsWith(K),async sendChatMessage(t,e){var s,i;if(this.operationDisabled)return void N.R.warn({message:i18n("qing31dd05")});if(!this.conversionList.find((t=>t.id===e))){var n;let t=null===(n=this.conversionList[0])||void 0===n?void 0:n.id;t||(t=K,this.newChatHandler()),this.activeConversionId=t,e=t}if("image"===(null===(s=this.selectedModel)||void 0===s?void 0:s.chatType))return void this.createMjMainTask(e,t);if("basicImage"===(null===(i=this.selectedModel)||void 0===i?void 0:i.chatType))return void this.createBasicImageTask(e,t);this.chatLoading=!0,this.controller=null,this.addUserMessage(t,e),this.createLoadingMsg(e);const o=this.isServerId(e)?e:void 0,[r,d]=await(0,a.DX)({conversationId:o,prompt:t,assistantId:this.activeAssistantId,model:this.activeSelectModel.id,networkMode:this.getNetworkMode()});if(r||!d)return void this.updatePendingMessage({conversionId:e,content:"网络错误，请重试",error:!0,done:!0});this.isRequestPage=!0;const[c,h,l]=d;l&&(this.controller=l),this.chatLoading=!1,c&&this.parserEventSource(c,e),h&&this.handleChatMessageData(h,e)},readStreamWithTimeout:(t,e)=>new Promise(((s,i)=>{const n=setTimeout((()=>{i(new O.V("timeout"))}),e);t.read().then((t=>{clearTimeout(n),s(t)})).catch((t=>{clearTimeout(n),i(t)}))})),parserEventSource(t,e){!async function(t,e){const s=t.getReader();let i;for(;!(i=await s.read()).done;)e(i.value)}(t,V(function(t,e,s){let i={data:"",event:"",id:"",retry:void 0};const n=new TextDecoder;return function(a,o){if(0===a.length)null==s||s(i),i={data:"",event:"",id:"",retry:void 0};else if(o>0){const s=n.decode(a.subarray(0,o)),r=o+(a[o+1]===q.Space?2:1),d=n.decode(a.subarray(r));switch(s){case"data":i.data=i.data?i.data+"\n"+d:d;break;case"event":i.event=d;break;case"id":t(i.id=d);break;case"retry":const s=parseInt(d,10);isNaN(s)||e(i.retry=s)}}}}((()=>null),(()=>null),(t=>{this.handleEventSourceMessage(t,e)}))))},handleEventSourceMessage(t,e){const s=t.data;if(s)try{const t=JSON.parse(s);this.handleChatMessageData(t,e)}catch(t){this.updatePendingMessage({conversionId:e,content:i18n("xi4c236a"),error:!0,done:!0})}},handleChatMessageData(t,e){const{id:s,type:i,content:n,arguments:a,modelId:o,name:r,restCount:d,toolId:c}=t.data||{};switch(t.code){case 201:this.updatePendingMessage({conversionId:e,modelId:o||"",content:"",id:s||""});break;case 202:"chat"===i?this.updatePendingMessage({conversionId:e,content:n,searchLoading:!1}):"tool_calls"===i&&(this.toolName=r||"",a&&(this.netSearchArguments=a));break;case 203:var h,l;if(d&&this.updateRestCount(d),"tool_calls"===i){if(c)this.toolCallId=c,this.updatePendingMessage({conversionId:e,content:"",searchLoading:!0,searchText:null===(h=this.netSearchArguments)||void 0===h?void 0:h.query,searchUrl:null===(l=this.netSearchArguments)||void 0===l?void 0:l.searchUrl}),this.handleChatCallToos(e)}else this.updatePendingMessage({conversionId:e,content:"",done:!0});break;case 4002:Y.EF?(0,G.bc)({type:G.o1.needLogin}):W.getProfile(),this.updatePendingMessage({conversionId:e,content:i18n("xi495bb4"),error:!0,done:!0});break;case 5003:case 1001:default:this.updatePendingMessage({conversionId:e,content:t.message||i18n("xi495bb4"),error:!0,done:!0});break;case 5004:this.updatePendingMessage({conversionId:e,content:t.message||i18n("xi495bb4"),error:!0,done:!0,showNewBtn:!0})}},async handleChatCallToos(t){this.toolCallId&&"network-access"===this.toolName&&this.chatToolGetWebSearchResult(t)},async chatToolGetWebSearchResult(t){if(this.netSearchArguments){this.netSearchLoading=!0;try{const[e,s]=await(0,a.iH)({chatToolId:this.toolCallId});if(e||!s)return void this.updatePendingMessage({conversionId:t,content:i18n("wang37ec65"),error:!0,done:!0});const[i,n,o]=s;o&&(this.controller=o),this.netSearchLoading=!1,i&&this.parserEventSource(i,t),n&&this.handleChatMessageData(n,t)}catch(t){}}},deleteLastMessage(t,e){const s=[...this.conversionList],i=s.find((t=>t.id===e)),n=p(i.messages,(e=>e.role===t));i.messages.splice(n,1),this.conversionList=s},updateLatestUserMessage(t){const e=[...this.conversionList],s=e.find((e=>e.id===t)),i=p(null==s?void 0:s.messages,(t=>"user"===t.role));i>-1&&(s.messages[i].assistantId=this.activeAssistantId||void 0),this.conversionList=e},async reGenerateLastAnwser(t){if(this.operationDisabled)return void N.R.warn({message:i18n("qing31dd05")});this.controller=null,this.chatLoading=!0;const e=[...this.conversionList].find((e=>e.id===t)),s=e.messages.find((t=>t.error));if(this.deleteLastMessage("assistant",t),s){const s=I(e.messages,(t=>"user"===t.role)).content;return this.deleteLastMessage("user",t),void this.sendChatMessage(s,t)}this.createLoadingMsg(t),this.updateLatestUserMessage(t);const[i,n]=await(0,a.B)({conversationId:t,assistantId:this.activeAssistantId,model:this.activeSelectModel.id,networkMode:this.getNetworkMode()});if(i||!n)return void this.updatePendingMessage({conversionId:t,content:i18n("wang37ec65"),error:!0,done:!0});this.isRequestPage=!0;const[o,r,d]=n;d&&(this.controller=d),this.chatLoading=!1,o&&this.parserEventSource(o,t),r&&this.handleChatMessageData(r,t)},setSponsorShow(t){this.sponsorShow=t},setVipTipsShow(t,e){this.vipTipsShow=t,this.vipTipsContent=e},setOverLimit(t){this.overLimit=t},abourtStream(){this.controller&&(this.controller.abort(),this.controller=null,this.updatePendingMessage({conversionId:this.activeConversionId,content:"",id:this.tempId,searchLoading:!1,done:!0}))},async getPlanList(){const[t,e]=await(0,a.t1)();!t&&e&&(this.planList=e.list||[],this.firstReq&&(this.planSelectedIndex=e.select,this.firstReq=!1))},setPlanSelectedIndex(t){this.planSelectedIndex=t},setSubPlanPeriodIndex(t){this.subPlanPeriodIndex=t},async getPayCode(t,e){const[s,i]=await(0,a.mr)(t,e);if(!s)return i},async getPayList(){const[t,e]=await(0,a.Hb)();if(!t)return e},async checkAllOrders(){const[t,e]=await(0,a.KC)(),s=e.chatai||{};return null===t&&(W.setChatStatus(s),s.vip)},async checkRecentOrderIds(t){const[e,s]=await(0,a.ud)(t);return null!==e?"":s.paidId},async getVipGroup(){const[t,e]=await(0,a.sT)();null===t&&this.setVipGroup(e)},readHistoryTips(){this.historyTipsReaded=!0},clearActiveAssistant(){this.activeAssistantId=""},setActiveAssistant(t){this.activeAssistantId=t,"chat"!==this.activeSelectModel.chatType&&this.setSelectModel()},setActiveAssistantToNext(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));t>-1?t===this.chatAssistantList.length-1?this.activeAssistantId="":this.activeAssistantId=this.chatAssistantList[t+1].id:this.activeAssistantId=this.chatAssistantList[0].id},setActiveAssistantToPrev(){const t=L(this.chatAssistantList,(t=>t.id===this.activeAssistantId));this.activeAssistantId=t>-1?0===t?"":this.chatAssistantList[t-1].id:this.chatAssistantList[this.chatAssistantList.length-1].id},setAssistantListStatus(t){var e;t&&null!==(e=this.chatAssistantList)&&void 0!==e&&e.length?this.assistantListShow=!0:this.assistantListShow=t},setStreamTimeout(t,e){this.updatePendingMessage({conversionId:t,content:"",id:this.tempId,done:!0,error:e})},setTheme(t){this.theme=t},async reqOrderList(t){const[e,s]=await(0,a.Fw)(t);null===e&&(this.orderList=s.list)},closeChatVipExpired(t){this.closedExpiredTime=t},unloadUpdatePending(){X.getState().pending&&this.isRequestPage&&X.setState({pending:!1,closeRequestPage:!0})},mutTabspendingOver(){if(this.activeConversionId===K){this.conversionList.find((t=>t.id===K))||(this.activeConversionId=this.conversionList[0].id)}},setCreateOrderParams(t){this.createOrderParams=t},async createPaymentOrder(t,e){const[s,i]=await(0,a.mr)(t,e);if(s)throw N.R.fail({message:s}),new Error(s);return this.paymentOrderData=i,this.isFreeOrder=0===this.paymentOrderData.newPlan.payAmount,this.localCurrentTime=Date.now(),this.payOrderIds.add(i.orderId),i},clearOrderIds(){this.payOrderIds.clear()},async getChatModels(){const[t,e]=await(0,a.fZ)();if(this.modelLoading=!1,t||!e)return;const s=e.find((t=>t.default));s&&(this.selectedModel=s),this.chatModelList=e},setSelectModel(t){var e;if(this.resetNetoption(),t)return this.selectedModel=t,void(null!==(e=t.chatType)&&void 0!==e&&e.toLowerCase().includes("image")&&(this.activeAssistantId=""));this.selectedModel=null},async getUserVipDetail(){this.vipDetailLoading=!0;const[t,e]=await(0,a.bI)();!t&&e&&(this.vipDetailLoading=!1,this.chatVipDetail=e)},async confirmChangePlanForFree(){if(!this.paymentOrderData)return;const[t,e]=await(0,a.wY)(this.paymentOrderData.orderId)},updateRestCount(t){this.chatVipDetail={...this.chatVipDetail,rest:{...this.chatVipDetail.rest,...t}}},releasePending(){const t=[...this.conversionList];let e=!1;t.forEach((t=>{const s=t.messages.find((t=>t.loading||t.pending));s&&(e=!0,s.loading=!1,s.pending=!1)})),e&&(this.conversionList=t)},async reqDouble11PlanList(){const[t,e]=await(0,a.J2)();!t&&e&&(this.double11PlanList=e.list,this.double11PlanSelect=e.select)},setDouble11PlanSelect(t){this.double11PlanSelect=t},setFromTag(t){this.fromTag=t},async reqExtraPack(){const[t,e]=await(0,a.UO)();!t&&e&&(this.extraPackList=e.list,this.extPlans=e.list.map((t=>({...t,planId:t.id,count:0}))))},changeExtPlans(t,e){const s=this.extPlans.findIndex((e=>e.planId===t));s>-1&&(this.extPlans[s].count=e)},async createExtPackOrder(t){const[e,s]=await(0,a.xK)({plans:t});if(!e&&s)return this.localCurrentTime=Date.now(),s},async checkExtPackOrder(t){const[e,s]=await(0,a.IB)(t);if(e)throw new Error(e);if(null!=s&&s.payStatus)return s;throw new Error("not paid")},resetExtPlans(){const t=this.extPlans.map((t=>({...t,count:0})));this.extPlans=t},async getExtraPackRemain(){const[t,e]=await(0,a.cQ)();!t&&e&&(this.extpackRest=e)},async reqExtraPackOrder(){const[t,e]=await(0,a.EI)();!t&&e&&(this.extraPackOrders=e.list)},setShowRenewalConfirm(t){this.showRenewalConfirm=t},async updateTempMjMessage(t,e,s){const i=[...this.conversionList],n=i.find((e=>e.id===t)).messages.find((t=>t.imageTaskId===e));n&&(s.error&&(n.error=!0,n.content=s.content,n.imageError=!!s.imageError),s.imageTaskId&&!s.error&&(n.imageTaskId=s.imageTaskId,n.imageId=s.imageId)),this.conversionList=i},sendMjMessage(t,e){const s=Date.now()+"";return this.addUserMessage(e,t),this.createLoadingMsg(t,"image",s),s},appendMjTask(t,e,s){this.mjTasks.add(`${t},${e},${s}`),this.mjTaskReqCount=0,J&&!J.closed||this.getTaskQueueInfo()},removeMjTask(t,e,s){this.mjTasks.delete(`${t},${e},${s}`)},clearMjTasks(){this.mjTasks.clear()},async createMjMainTask(t,e){const s=this.sendMjMessage(t,e),i=this.isServerId(t)?t:void 0;try{const[n,o]=await(0,a.uW)({prompt:e,conversationId:i});if(n||!o)return void this.updateTempMjMessage(t,s,{error:!0,content:o.message||i18n("chuang4ab364"),extra:5008===o.code});if(o.conversationId&&t!==o.conversationId){const e=[...this.conversionList];e.find((e=>e.id===t)).id=o.conversationId,this.conversionList=e,this.activeConversionId===t&&(this.activeConversionId=o.conversationId)}return this.updateTempMjMessage(o.conversationId,s,{imageId:o.imageId,imageTaskId:o.task_id,imageTaskType:"MainTask",imageStatucCode:0}),this.appendMjTask(o.conversationId,o.task_id,o.imageId),this.updateRestCount({image:o.restImageCount}),o}catch(e){return void this.updateTempMjMessage(t,s,{error:!0,imageError:!0})}},async createMjSubTask(t,e){if(this.pendingMainTaskIds.has(t))return void N.R.warn({message:i18n("qing332e8a")});const s=this.activeConversionId,i=this.sendMjMessage(s,e);this.pendingMainTaskIds.add(t);try{const[n,o]=await(0,a.N$)({task_id:t,action:e,conversationId:s});return n||!o?void this.updateTempMjMessage(s,i,{error:!0,content:o.message||i18n("chuang4ab364"),extra:5008===o.code}):(this.updateTempMjMessage(o.conversationId,i,{imageTaskId:o.task_id,imageId:o.imageId,imageStatucCode:0}),this.appendMjTask(o.conversationId,o.task_id,o.imageId),this.updateRestCount({image:o.restImageCount}),o)}catch(t){return void this.updateTempMjMessage(s,i,{error:!0,imageError:!0})}},async queryTasks(){const t=[...this.mjTasks].slice(-3).map((t=>t.split(",")));var e,s;if(0===t.length)return void(null===(e=J)||void 0===e||e.unsubscribe());if(this.mjTaskReqCount>=100)return void(null===(s=J)||void 0===s||s.unsubscribe());const i=t.map((t=>{let[e,s,i]=t;return this.queryTaskAndUpdate(e,s,i)})),n=await Promise.all(i);this.mjTaskReqCount=this.mjTaskReqCount+1;const a=(0,A.Z)(n);if(0===a.length)throw new Error(t.length+"");const o=[...this.conversionList];if(a.forEach((t=>{t.parentTaskId&&this.pendingMainTaskIds.delete(t.parentTaskId),2!==t.status_code&&3!==t.status_code||this.removeMjTask(t.conversationId,t.taskId,t.imageId);const e=o.find((e=>e.id===t.conversationId));if(e){const s=e.messages.find((e=>e.imageTaskId===t.taskId&&e.imageId===t.imageId));if(!s)return;s.imageStatus=t.status,s.imageStatucCode=t.status_code,s.imageUrl=t.image_url,s.rawImageUrl=t.raw_image_url,s.imageTaskType=t.taskType}})),this.conversionList=o,t.length>0)throw new Error(t.length+"")},async getTaskQueueInfo(){if(!J||J.closed){var t;if(0===this.mjTasks.size)return this.mjTaskReqCount=0,void(null===(t=J)||void 0===t||t.unsubscribe());J=(0,_.H)(3e3).pipe((0,F.z)((()=>this.queryTasks())),(0,Z.X)({delay:()=>(0,_.H)(6e3)})).subscribe((()=>{var t;null===(t=J)||void 0===t||t.unsubscribe()}))}},async queryTaskAndUpdate(t,e,s){const[i,n]=await(0,a.Eg)({task_id:e,conversationId:t,imageId:s});return i||!n?null:{status:n.status,status_code:n.status_code,image_url:n.image_url,raw_image_url:n.raw_image_url,restChange:n.restChange,taskType:n.taskType,parentTaskId:n.parentTaskId,conversationId:t,taskId:e,imageId:s}},setUploadModal(t){this.uploadDocModalShow=t},async openUploadDialog(){if(!this.preUploadLoading){this.preUploadLoading=!0;try{const[t,e]=await(0,a.Mz)();if(this.preUploadLoading=!1,t||!e)return void N.R.fail({message:t||i18n("qing39481c")});this.selectDocFile=null,this.uploadMetaData=e,this.uploadDocConversationId="",this.uploadDocModalShow=!0,this.resetNetoption()}catch(t){this.preUploadLoading=!1,N.R.fail({message:i18n("qing338d8b")})}}},setSelectDocFile(t){this.selectDocFile=t},async getAccessibleUploadHost(t){const e="chatDocUploadUrl",s=localStorage.getItem(e),i=localStorage.getItem("chatDocUploadUrl_time");if(s&&i){if(Date.now()-Number(i)<6e5)return s}const n=await(0,B.Kn)(e,t);return n||""},async startUploadDocFile(){if(!this.selectDocFile)return;this.uploadDocLoading=!0;const[t,e]=await(0,a.SK)();if(t||!e)return void N.R.fail({message:t||i18n("wang37ec65")});if(!e.id)return N.R.fail({message:i18n("wang37ec65")}),void(this.uploadDocLoading=!1);const s=e.url,i=x(s),n=await this.getAccessibleUploadHost(i);if(!n)return this.uploadDocLoading=!1,void N.R.fail({message:i18n("wang37ec65")});this.uploadDocConversationId=this.activeConversionId;try{var o,r;const t=await this.uploadChatDocFile(n,{id:e.id,headers:e.headers});await this.uploadDocSuccess(t),this.activeAssistantId="","image"!==(null===(o=this.selectedModel)||void 0===o?void 0:o.chatType)&&"basicImage"!==(null===(r=this.selectedModel)||void 0===r?void 0:r.chatType)||this.setSelectModel()}catch(t){N.R.fail({message:"string"==typeof t?t:i18n("shang48e2f9")})}this.uploadDocModalShow=!1,this.uploadDocLoading=!1},async uploadChatDocFile(t,e){var s;const[i,n]=await(0,a.EB)(t,this.selectDocFile,e.headers);if(i||!n)throw i;return{docId:n.docId,uploadId:e.id,filename:(null===(s=this.selectDocFile)||void 0===s?void 0:s.name)||n.key,conversationId:this.activeConversionId}},async uploadDocSuccess(t){const[e,s]=await(0,a.ml)({...t,conversationId:this.isServerId(this.activeConversionId)?this.activeConversionId:void 0});if(e||!s)throw e;this.updateRestCount({4:s.rest4});const i=[...this.conversionList],n=i.find((e=>e.id===t.conversationId));n&&(this.isServerId(t.conversationId)||(n.id=s.conversationId,this.activeConversionId=s.conversationId),n.messages.push({role:"user",content:i18n("asymbol2f498"),filename:t.filename,chatType:"document"})),this.conversionList=i},async getCoUserDetail(){if(!W.user.userType)return;if(Date.now()-this.coUserTypeData.updateTime<36e5)return;const[t,e]=await(0,o.sG)();!t&&e&&(this.coUserTypeData={...e,updateTime:Date.now()})},sendBasicImageMessage(t,e){const s=Date.now()+"";return this.addUserMessage(e,t),this.createLoadingMsg(t,"basicImage",s),s},async updateTempBasicImageMessage(t,e,s){const i=[...this.conversionList],n=i.find((e=>e.id===t)).messages.find((t=>t.imageId===e));n&&(s.error?(n.error=!0,n.content=s.content,n.imageError=!!s.imageError):(n.imageId=s.imageId,n.imageUrl=s.imageUrl,n.forbidden=s.forbidden),n.processing=!1),this.conversionList=i},async createBasicImageTask(t,e){const s=this.sendBasicImageMessage(t,e),i=this.isServerId(t)?t:void 0,[n,o]=await(0,a.lo)({prompt:e,conversationId:i});if(!n&&o){if(o.conversationId&&t!==o.conversationId){const e=[...this.conversionList];e.find((e=>e.id===t)).id=o.conversationId,this.conversionList=e,this.activeConversionId===t&&(this.activeConversionId=o.conversationId)}this.updateTempBasicImageMessage(o.conversationId,s,{imageId:o.imageId,imageUrl:o.imageUrl,forbidden:o.forbidden})}else this.updateTempBasicImageMessage(t,s,{error:!0,content:o.message||i18n("chuang4ab364"),extra:5008===o.code})},async getInfinityAiSubPlan(){const[t,e]=await(0,a.w1)();!t&&e&&(this.subPlanList=e.list,this.subPlanPeriodIndex||(this.subPlanPeriodIndex=e.select),this.highlihgtPlanProduct||(this.highlihgtPlanProduct=e.selectProduct))},async createInfinityAiSubOrder(t){const e={planId:t};W.user.email&&(e.email=W.user.email);const[s,i]=await(0,a.p)(e);return s||!i?(N.R.fail({message:s||i18n("wang37ec65")}),null):i},async checkInfinityAiSubOrder(){const[t,e]=await(0,a.WB)();return!t&&e},async cancelInfinityAiSub(){const[t,e]=await(0,a.NF)();return t||!e?(N.R.warn({message:t||"operation failed"}),!1):(await this.getUserVipDetail(),e)},async resumeInfinityAiSub(){const[t,e]=await(0,a.g8)();return t||!e?(N.R.warn({message:t||"operation failed"}),!1):(await this.getUserVipDetail(),e)}}});window.addEventListener("beforeunload",(()=>(et().unloadUpdatePending(),!0)));const st=(0,R.Z)(et().mutTabspendingOver,100)},6146:(t,e,s)=>{s.d(e,{Z:()=>i});const i=function(t,e,s,i){for(var n=t.length,a=s+(i?1:-1);i?a--:++a<n;)if(e(t[a],a,t))return a;return-1}},8424:(t,e,s)=>{s.d(e,{Z:()=>o});var i=s(6146);const n=function(t){return t!=t};const a=function(t,e,s){for(var i=s-1,n=t.length;++i<n;)if(t[i]===e)return i;return-1};const o=function(t,e,s){return e==e?a(t,e,s):(0,i.Z)(t,n,s)}}}]);